<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Export Details</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/maplibre-gl@3/dist/maplibre-gl.js"></script>
    <link
      href="https://unpkg.com/maplibre-gl@3/dist/maplibre-gl.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-gray-50">
    <div class="min-h-screen">
      <nav class="bg-white shadow-sm border-b">
        <div
          class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between h-16 items-center"
        >
          <h1 class="text-2xl font-bold text-primary">OBE Export Details</h1>
          <a href="/" class="text-primary hover:underline">Back to Exports</a>
        </div>
      </nav>
      <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div id="export-details" class="mb-8"></div>
        <div id="runs-list" class="mb-8"></div>
        <div>
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Export Area</h3>
          <div id="map" class="w-full h-96 rounded-lg border"></div>
        </div>
      </main>
    </div>
    <script>
      let exportId = null;
      if (window.location.search) {
        const urlParams = new URLSearchParams(window.location.search);
        exportId = urlParams.get("id");
      }
      if (!exportId && typeof export_id !== "undefined") {
        exportId = export_id;
      }
      if (!exportId) {
        const match = window.location.pathname.match(/\/exports\/([\w-]+)/);
        if (match) exportId = match[1];
      }
      let map;
      let exportData;
      let runs = [];

      async function fetchExport() {
        const token = localStorage.getItem("access_token");
        const res = await fetch(`/api/exports/${exportId}/`, {
          headers: token ? { Authorization: `Bearer ${token}` } : {},
        });
        exportData = await res.json();
      }

      async function fetchRuns() {
        const token = localStorage.getItem("access_token");
        const res = await fetch(`/api/exports/${exportId}/runs/`, {
          headers: token ? { Authorization: `Bearer ${token}` } : {},
        });
        const data = await res.json();
        runs = data.results || [];
      }

      function renderExportDetails() {
        const p = exportData.properties || exportData;
        document.getElementById("export-details").innerHTML = `
          <div class="bg-white rounded-lg border p-6 mb-4">
            <div class="flex justify-between items-center mb-2">
              <h2 class="text-2xl font-bold text-gray-900">${
                p.name || "Unnamed Export"
              }</h2>
              <span class="text-xs px-2 py-1 rounded ${
                p.is_public
                  ? "bg-green-100 text-green-800"
                  : "bg-gray-100 text-gray-800"
              }">
                ${p.is_public ? "Public" : "Private"}
              </span>
            </div>
            <p class="text-gray-700 mb-2">${
              p.description || "No description"
            }</p>
            <div class="flex flex-wrap gap-4 text-sm text-gray-600">
              <div>Source: <span class="font-medium">${
                p.source || "-"
              }</span></div>
              <div>Format: <span class="font-medium">${
                p.output_format || "-"
              }</span></div>
              <div>Created: <span class="font-medium">${
                p.created_at ? new Date(p.created_at).toLocaleString() : "-"
              }</span></div>
              <div>Updated: <span class="font-medium">${
                p.updated_at ? new Date(p.updated_at).toLocaleString() : "-"
              }</span></div>
              <div>User: <span class="font-medium">${p.user || "-"}</span></div>
            </div>
            <div class="mt-4">
              <button id="rerun-btn" class="px-5 py-2.5 bg-green-600 text-white font-semibold rounded-lg shadow hover:bg-green-700 transition disabled:opacity-60 disabled:cursor-not-allowed">Rerun Export</button>
            </div>
          </div>
        `;
        document.getElementById("rerun-btn").onclick = rerunExport;
        let rerunPolling = null;
        async function rerunExport() {
          const btn = document.getElementById("rerun-btn");
          btn.disabled = true;
          btn.textContent = "Rerunning...";
          const token = localStorage.getItem("access_token");
          const res = await fetch(`/api/exports/rerun/${exportId}/`, {
            method: "POST",
            headers: token ? { Authorization: `Bearer ${token}` } : {},
          });
          if (res.ok) {
            pollRuns();
          } else {
            btn.disabled = false;
            btn.textContent = "Rerun Export";
            alert("Failed to rerun export");
          }
        }

        async function pollRuns() {
          if (rerunPolling) clearInterval(rerunPolling);
          rerunPolling = setInterval(async () => {
            await fetchRuns();
            renderRuns();
            // If no run is queued or processing, re-enable the button
            const running = runs.some(
              (r) => r.status === "queued" || r.status === "processing"
            );
            const btn = document.getElementById("rerun-btn");
            if (!running && btn) {
              btn.disabled = false;
              btn.textContent = "Rerun Export";
              clearInterval(rerunPolling);
            }
          }, 3000);
        }
      }

      function renderRuns() {
        if (!runs.length) {
          document.getElementById("runs-list").innerHTML =
            '<div class="text-gray-500 text-center">No runs yet.</div>';
          return;
        }
        let rows = runs
          .map(
            (run) => `
          <tr>
            <td class="pr-4 py-2">${run.status}</td>
            <td class="pr-4 py-2">${
              run.started_at ? new Date(run.started_at).toLocaleString() : "-"
            }</td>
            <td class="pr-4 py-2">${
              run.completed_at
                ? new Date(run.completed_at).toLocaleString()
                : "-"
            }</td>
            <td class="pr-4 py-2">${run.building_count ?? "-"}</td>
            <td class="pr-4 py-2">${
              run.file_size ? (run.file_size / 1024).toFixed(1) + " KB" : "-"
            }</td>
            <td class="pr-4 py-2">${run.duration || "-"}</td>
          </tr>
        `
          )
          .join("");
        document.getElementById("runs-list").innerHTML = `
          <div class="bg-white rounded-lg border p-6">
            <h3 class="text-lg font-semibold mb-4">Runs</h3>
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead><tr class="text-left text-gray-700">
                  <th class="pr-4 py-2">Status</th>
                  <th class="pr-4 py-2">Started</th>
                  <th class="pr-4 py-2">Completed</th>
                  <th class="pr-4 py-2">Buildings</th>
                  <th class="pr-4 py-2">File Size</th>
                  <th class="pr-4 py-2">Duration</th>
                </tr></thead>
                <tbody>${rows}</tbody>
              </table>
            </div>
          </div>
        `;
      }

      function renderMap() {
        if (!exportData.geometry) return;
        if (!map) {
          map = new maplibregl.Map({
            container: "map",
            style:
              "https://basemaps.cartocdn.com/gl/positron-gl-style/style.json",
            center: [0, 20],
            zoom: 2,
          });
          map.on("style.load", () => addAoiToMap());
        } else if (map.isStyleLoaded()) {
          addAoiToMap();
        } else {
          map.once("style.load", () => addAoiToMap());
        }
        function addAoiToMap() {
          if (map.getSource("aoi")) {
            if (map.getLayer("aoi-fill")) map.removeLayer("aoi-fill");
            map.removeSource("aoi");
          }
          map.addSource("aoi", {
            type: "geojson",
            data: {
              type: "FeatureCollection",
              features: [{ type: "Feature", geometry: exportData.geometry }],
            },
          });
          map.addLayer({
            id: "aoi-fill",
            type: "fill",
            source: "aoi",
            paint: { "fill-color": "#059669", "fill-opacity": 0.2 },
          });
          // Fit bounds to the polygon
          const geom = exportData.geometry;
          if (
            geom.type === "Polygon" &&
            geom.coordinates &&
            geom.coordinates[0]
          ) {
            const coords = geom.coordinates[0];
            const bounds = coords.reduce(
              (b, c) => b.extend(c),
              new maplibregl.LngLatBounds(coords[0], coords[0])
            );
            map.fitBounds(bounds, { padding: 20 });
          }
        }
      }

      async function loadAll() {
        await fetchExport();
        await fetchRuns();
        renderExportDetails();
        renderRuns();
        renderMap();
      }
      loadAll();
    </script>
  </body>
</html>
