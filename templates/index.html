<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OBE - Open Building Exports</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css"
    />
    <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
    <script src="https://unpkg.com/pmtiles@3.0.7/dist/pmtiles.js"></script>
    <script src="https://unpkg.com/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.js"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.css"
    />
    <style>
      .maplibregl-ctrl-top-right {
        z-index: 2;
      }
      .maplibregl-draw-polygon.maplibregl-draw-active {
        cursor: crosshair;
      }
      .search-dropdown {
        max-height: 200px;
        overflow-y: auto;
      }
      #map {
        height: 70vh;
        min-height: 400px;
      }

      .tooltip {
        position: relative;
        cursor: help;
      }

      .tooltip:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        white-space: nowrap;
        z-index: 9999;
        opacity: 1;
        transition: opacity 0.2s;
        pointer-events: none;
      }

      .tooltip:hover::before {
        content: "";
        position: absolute;
        bottom: 120%;
        left: 50%;
        transform: translateX(-50%);
        border: 5px solid transparent;
        border-top-color: rgba(0, 0, 0, 0.9);
        z-index: 9999;
        pointer-events: none;
      }

      .export-card {
        transition: all 0.2s ease-in-out;
      }

      .export-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
      }

      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
      }

      .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 3px;
      }

      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #10b981;
        border-radius: 3px;
      }

      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #059669;
      }

      @media (max-width: 768px) {
        #map {
          height: 50vh;
          min-height: 300px;
        }
        .grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <div class="bg-white shadow-sm border-b">
      <div
        class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center"
      >
        <h1
          class="text-2xl font-bold text-emerald-600 cursor-pointer"
          onclick="app.showExports()"
        >
          OBE
        </h1>
        <div id="auth-buttons" class="flex space-x-3">
          <button
            id="login-btn"
            class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded"
          >
            Login
          </button>
          <button
            id="signup-btn"
            class="px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700"
          >
            Sign Up
          </button>
          <button
            id="logout-btn"
            class="hidden px-4 py-2 text-gray-600 hover:bg-gray-100 rounded"
          >
            Logout
          </button>
        </div>
      </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 py-6">
      <div id="main-grid" class="grid grid-cols-1 xl:grid-cols-3 gap-6">
        <div id="left-panel" class="lg:col-span-1">
          <div
            class="bg-white rounded-lg shadow-sm h-[calc(100vh-200px)] min-h-[600px] flex flex-col"
          >
            <div id="exports-view" class="p-6 flex-1 overflow-y-auto">
              <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold">Exports</h2>
                <div class="flex space-x-2">
                  <button
                    id="show-all"
                    class="px-3 py-1 text-sm bg-emerald-100 text-emerald-700 rounded transition-colors"
                  >
                    All
                  </button>
                  <button
                    id="show-mine"
                    class="hidden px-3 py-1 text-sm text-gray-600 hover:bg-gray-100 rounded transition-colors"
                  >
                    Mine
                  </button>
                  <button
                    id="create-new"
                    class="px-3 py-1 text-sm bg-emerald-600 text-white rounded hover:bg-emerald-700 transition-colors"
                  >
                    + New
                  </button>
                </div>
              </div>
              <div
                id="exports-list"
                class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar"
              ></div>
            </div>

            <div id="auth-view" class="hidden p-6">
              <h2 id="auth-title" class="text-xl font-semibold mb-6">Login</h2>
              <form id="auth-form" class="space-y-4">
                <input
                  id="username"
                  type="text"
                  placeholder="Username"
                  required
                  class="w-full px-3 py-2 border rounded focus:border-emerald-500"
                />
                <input
                  id="email"
                  type="email"
                  placeholder="Email"
                  class="hidden w-full px-3 py-2 border rounded focus:border-emerald-500"
                />
                <input
                  id="password"
                  type="password"
                  placeholder="Password"
                  required
                  class="w-full px-3 py-2 border rounded focus:border-emerald-500"
                />
                <input
                  id="password-confirm"
                  type="password"
                  placeholder="Confirm Password"
                  class="hidden w-full px-3 py-2 border rounded focus:border-emerald-500"
                />
                <div id="auth-error" class="hidden text-red-600 text-sm"></div>
                <div class="flex space-x-3">
                  <button
                    type="submit"
                    class="flex-1 bg-emerald-600 text-white py-2 rounded hover:bg-emerald-700"
                  >
                    <span id="auth-btn-text">Login</span>
                  </button>
                  <button
                    type="button"
                    id="auth-cancel"
                    class="flex-1 bg-gray-300 text-gray-700 py-2 rounded hover:bg-gray-400"
                  >
                    Cancel
                  </button>
                </div>
                <button
                  type="button"
                  id="auth-toggle"
                  class="w-full text-sm text-emerald-600 hover:text-emerald-700"
                >
                  Don't have an account? Sign up
                </button>
              </form>
            </div>

            <div id="create-view" class="hidden p-6">
              <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold">Create Export</h2>
                <button
                  id="create-cancel"
                  class="text-gray-500 hover:text-gray-700"
                >
                  ✕
                </button>
              </div>
              <div
                id="draw-status"
                class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-800"
              >
                Draw area on map or upload file
              </div>
              <form id="create-form" class="space-y-4">
                <input
                  id="export-name"
                  type="text"
                  placeholder="Export name"
                  required
                  class="w-full px-3 py-2 border rounded focus:border-emerald-500"
                />
                <textarea
                  id="export-desc"
                  placeholder="Description (optional)"
                  class="w-full px-3 py-2 border rounded focus:border-emerald-500 h-16"
                ></textarea>
                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="block text-sm font-medium mb-1">Source</label>
                    <select
                      id="export-source"
                      multiple
                      class="w-full px-3 py-2 border rounded focus:border-emerald-500 h-20 text-sm"
                    >
                      <option value="google">Google</option>
                      <option value="microsoft">Microsoft</option>
                      <option value="osm">OpenStreetMap</option>
                      <option value="overture">Overture</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-1">Format</label>
                    <select
                      id="export-format"
                      multiple
                      class="w-full px-3 py-2 border rounded focus:border-emerald-500 h-20 text-sm"
                    >
                      <option value="geoparquet">GeoParquet</option>
                      <option value="geojson">GeoJSON</option>
                      <option value="shapefile">Shapefile</option>
                      <option value="geopackage">GeoPackage</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">
                      Vector tiles generated automatically for web viewing
                    </p>
                  </div>
                </div>
                <div id="source-configs" class="space-y-3"></div>
                <div class="flex items-center space-x-2">
                  <input id="export-public" type="checkbox" class="rounded" />
                  <label class="text-sm">Make public</label>
                </div>
                <div
                  class="border-2 border-dashed border-gray-300 rounded p-4 text-center"
                >
                  <input
                    type="file"
                    id="file-upload"
                    accept=".geojson,.json,.kml,.gpx"
                    class="hidden"
                  />
                  <button
                    type="button"
                    id="upload-btn"
                    class="text-emerald-600 hover:text-emerald-700"
                  >
                    Upload boundary file
                  </button>
                  <p class="text-xs text-gray-500 mt-1">GeoJSON, KML, GPX</p>
                </div>
                <div
                  id="create-error"
                  class="hidden text-red-600 text-sm"
                ></div>
                <button
                  type="submit"
                  id="create-submit"
                  disabled
                  class="w-full bg-gray-400 text-white py-2 rounded cursor-not-allowed"
                >
                  Create Export
                </button>
              </form>
            </div>

            <div id="detail-view" class="hidden flex flex-col h-full">
              <div class="flex items-center justify-between p-4 border-b">
                <h2 class="text-lg font-semibold">Export Details</h2>
                <div class="flex items-center space-x-2">
                  <button
                    id="rerun-export-btn"
                    class="px-3 py-1 text-sm bg-emerald-600 text-white rounded hover:bg-emerald-700 transition-colors"
                    onclick="app.rerunExport(app.selectedExport?.properties?.id)"
                  >
                    Rerun Export
                  </button>
                  <button
                    id="detail-cancel"
                    class="text-gray-500 hover:text-gray-700"
                  >
                    ✕
                  </button>
                </div>
              </div>
              <div id="export-details" class="p-4 border-b bg-gray-50"></div>
              <div class="flex-1 flex flex-col p-4 min-h-0">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-md font-semibold">Export Runs</h3>
                  <span id="runs-count" class="text-sm text-gray-500"></span>
                </div>
                <div
                  id="runs-list"
                  class="flex-1 overflow-y-auto space-y-2"
                ></div>
              </div>
            </div>

            <div id="run-detail-view" class="hidden flex flex-col h-full">
              <div class="flex items-center justify-between p-4 border-b">
                <div class="flex items-center space-x-3">
                  <button
                    id="run-detail-back"
                    class="p-1 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded"
                  >
                    <svg
                      class="w-5 h-5"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 19l-7-7 7-7"
                      ></path>
                    </svg>
                  </button>
                  <h2 class="text-lg font-semibold">Run Details</h2>
                </div>
                <button
                  id="run-detail-cancel"
                  class="text-gray-500 hover:text-gray-700"
                >
                  ✕
                </button>
              </div>
              <div id="run-details" class="flex-1 p-4 overflow-y-auto"></div>
            </div>
          </div>
        </div>

        <div id="right-panel" class="lg:col-span-2">
          <div
            class="bg-white rounded-lg shadow-sm h-[calc(100vh-200px)] min-h-[600px] flex flex-col"
          >
            <div class="flex justify-between items-center p-4 border-b">
              <h3 class="font-semibold text-gray-800">Interactive Map</h3>
              <button
                id="expand-map"
                class="px-3 py-1 text-sm bg-emerald-100 text-emerald-700 hover:bg-emerald-200 rounded transition-colors flex items-center space-x-1"
                title="Fullscreen Map"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"
                  ></path>
                </svg>
                <span>Enlarge</span>
              </button>
            </div>
            <div class="flex-1">
              <div id="map" class="w-full h-full rounded border"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div
      id="fullscreen-map"
      class="hidden fixed inset-0 bg-black bg-opacity-90 z-50"
    >
      <div class="flex flex-col h-screen">
        <div class="flex justify-between items-center p-4 bg-white">
          <h3 class="text-lg font-semibold text-gray-800">Fullscreen View</h3>
          <button
            id="close-fullscreen"
            class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded transition-colors"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>
        <div id="fullscreen-map-container" class="flex-1 p-4"></div>
      </div>
    </div>

    <script>
      class OBEApp {
        constructor() {
          this.exports = [];
          this.user = null;
          this.showMine = false;
          this.currentView = "exports";
          this.drawnArea = null;
          this.isLogin = true;
          this.countries = [];
          this.selectedExport = null;
          this.currentRunId = null;
          this.pmtilesLayers = [];
          this.init();
        }

        async init() {
          let protocol = new pmtiles.Protocol();
          maplibregl.addProtocol("pmtiles", protocol.tile);

          await this.loadCountries();
          this.map = new maplibregl.Map({
            container: "map",
            style:
              "https://basemaps.cartocdn.com/gl/positron-gl-style/style.json",
            center: [0, 20],
            zoom: 2,
          });

          this.map.on("load", () => {
            this.draw = new MapboxDraw({
              displayControlsDefault: false,
              controls: { polygon: true, trash: true },
              defaultMode: "simple_select",
            });
            this.map.addControl(this.draw, "top-right");
            this.map.on("draw.create", (e) =>
              this.updateDrawnArea(e.features[0])
            );
            this.map.on("draw.update", (e) =>
              this.updateDrawnArea(e.features[0])
            );
            this.map.on("draw.delete", () => this.updateDrawnArea(null));

            this.map.on("click", (e) => {
              this.handleMapClick(e);
            });
          });

          this.setupEvents();
          this.handleUrlRouting();
          this.checkAuth();
          this.loadExports();
        }

        async loadCountries() {
          try {
            const response = await fetch(
              "https://raw.githubusercontent.com/kshitijrajsharma/global-boundaries-bbox/refs/heads/main/countries.json"
            );
            this.countries = await response.json();
          } catch (error) {
            console.error("Failed to load countries:", error);
            this.countries = [];
          }
        }

        async apiCall(endpoint, options = {}) {
          const token = localStorage.getItem("access_token");
          const headers = { "Content-Type": "application/json" };
          if (token) headers.Authorization = `Bearer ${token}`;

          const response = await fetch(`/api${endpoint}`, {
            ...options,
            headers: { ...headers, ...options.headers },
          });

          if (!response.ok) {
            if (response.status === 401 && token) {
              this.logout();
              this.showErrorToast("Session expired. Please login again.");
              return null;
            }
            const data = await response.json();
            throw new Error(data.detail || "Request failed");
          }
          return await response.json();
        }

        checkAuth() {
          const token = localStorage.getItem("access_token");
          const username = localStorage.getItem("username");
          if (token && username) this.user = username;
          this.render();
        }

        async loadExports() {
          try {
            let data;
            if (this.showMine && this.user) {
              data = await this.apiCall("/exports/?ordering=-created_at");
            } else {
              data = await this.apiCall(
                "/public/exports/?ordering=-created_at"
              );
            }
            if (data) {
              this.exports = data.results?.features || data.features || [];
              console.log("Loaded exports:", this.exports);
            } else {
              this.exports = [];
            }
          } catch (error) {
            console.error("Failed to load exports:", error);
            this.exports = [];
          }
          this.render();
        }

        setupEvents() {
          document.getElementById("login-btn").onclick = () =>
            this.showAuth(true);
          document.getElementById("signup-btn").onclick = () =>
            this.showAuth(false);
          document.getElementById("logout-btn").onclick = () => this.logout();
          document.getElementById("show-all").onclick = () =>
            this.toggleFilter(false);
          document.getElementById("show-mine").onclick = () =>
            this.toggleFilter(true);
          document.getElementById("create-new").onclick = () =>
            this.showCreate();
          document.getElementById("expand-map").onclick = () =>
            this.expandMap();
          document.getElementById("close-fullscreen").onclick = () =>
            this.closeFullscreen();
          document.getElementById("auth-cancel").onclick = () =>
            this.showExports();
          document.getElementById("auth-toggle").onclick = () =>
            this.toggleAuthMode();
          document.getElementById("create-cancel").onclick = () =>
            this.showExports();
          document.getElementById("detail-cancel").onclick = () =>
            this.showExports();
          document.getElementById("run-detail-back").onclick = () =>
            this.showDetail(this.currentExportId);
          document.getElementById("run-detail-cancel").onclick = () =>
            this.showExports();
          document.getElementById("export-source").onchange = () =>
            this.updateSourceConfigs();
          document.getElementById("upload-btn").onclick = () =>
            document.getElementById("file-upload").click();
          document.getElementById("file-upload").onchange = (e) =>
            this.handleFileUpload(e);
          document.getElementById("auth-form").onsubmit = (e) =>
            this.handleAuth(e);
          document.getElementById("create-form").onsubmit = (e) =>
            this.handleCreate(e);
        }

        showAuth(isLogin) {
          this.isLogin = isLogin;
          this.currentView = "auth";
          this.render();
        }

        showExports() {
          this.currentView = "exports";
          this.selectedExport = null;
          this.render();
        }

        showCreate() {
          if (!this.user) {
            this.showAuth(true);
            return;
          }
          this.currentView = "create";
          if (this.draw) this.draw.changeMode("draw_polygon");
          this.render();
        }

        showDetail(exportId) {
          this.selectedExport = this.exports.find(
            (e) => (e.properties?.id || e.id) === exportId
          );
          this.currentView = "detail";
          this.render();
          this.loadExportRuns(exportId);
        }

        async loadExportRuns(exportId) {
          try {
            const data = await this.apiCall(`/exports/${exportId}/runs/`);
            this.currentExportRuns = data.results || [];
            this.renderRuns(this.currentExportRuns);
          } catch (error) {
            console.error("Failed to load runs:", error);
          }
        }

        toggleFilter(mine) {
          this.showMine = mine;
          this.loadExports();
        }

        toggleAuthMode() {
          this.isLogin = !this.isLogin;
          this.render();
        }

        updateSourceConfigs() {
          const sourceSelect = document.getElementById("export-source");
          const configContainer = document.getElementById("source-configs");
          const selectedSources = Array.from(sourceSelect.selectedOptions).map(
            (option) => option.value
          );

          configContainer.innerHTML = "";

          selectedSources.forEach((source) => {
            if (source === "microsoft") {
              configContainer.innerHTML += `
                            <div class="microsoft-config">
                                <label class="block text-sm font-medium mb-1">Microsoft Location</label>
                                <div class="relative">
                                    <input id="microsoft-search" type="text" placeholder="Search country..." class="w-full px-3 py-2 border rounded focus:border-emerald-500">
                                    <div id="microsoft-dropdown" class="hidden absolute z-10 w-full bg-white border rounded-b shadow-lg search-dropdown">
                                        ${this.countries
                                          .map(
                                            (country) =>
                                              `<div class="px-3 py-2 hover:bg-gray-100 cursor-pointer country-option" data-value="${country.shapeName}">${country.shapeName}</div>`
                                          )
                                          .join("")}
                                    </div>
                                </div>
                            </div>
                        `;

              setTimeout(() => {
                const searchInput = document.getElementById("microsoft-search");
                const dropdown = document.getElementById("microsoft-dropdown");
                searchInput.onfocus = () => dropdown.classList.remove("hidden");
                searchInput.onblur = () =>
                  setTimeout(() => dropdown.classList.add("hidden"), 200);
                searchInput.oninput = (e) =>
                  this.filterCountries(e.target.value);
                dropdown.onclick = (e) => {
                  if (e.target.classList.contains("country-option")) {
                    searchInput.value = e.target.dataset.value;
                    dropdown.classList.add("hidden");
                  }
                };
              }, 100);
            }
          });
        }

        filterCountries(query) {
          const options = document.querySelectorAll(".country-option");
          options.forEach((option) => {
            const matches = option.textContent
              .toLowerCase()
              .includes(query.toLowerCase());
            option.style.display = matches ? "block" : "none";
          });
        }

        updateDrawnArea(area) {
          this.drawnArea = area;
          if (this.currentView === "create") this.updateCreateButton();
        }

        updateCreateButton() {
          const btn = document.getElementById("create-submit");
          const status = document.getElementById("draw-status");

          if (this.drawnArea) {
            btn.disabled = false;
            btn.className =
              "w-full bg-emerald-600 text-white py-2 rounded hover:bg-emerald-700";
            status.innerHTML = "Area selected";
            status.className =
              "mb-4 p-3 bg-green-50 border border-green-200 rounded text-sm text-green-800";
          } else {
            btn.disabled = true;
            btn.className =
              "w-full bg-gray-400 text-white py-2 rounded cursor-not-allowed";
            status.innerHTML = "Draw area on map or upload file";
            status.className =
              "mb-4 p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-800";
          }
        }

        async handleAuth(e) {
          e.preventDefault();
          const username = document.getElementById("username").value;
          const password = document.getElementById("password").value;
          const passwordConfirm =
            document.getElementById("password-confirm").value;
          const email = document.getElementById("email").value;

          document.getElementById("auth-error").classList.add("hidden");

          if (!this.isLogin && password !== passwordConfirm) {
            document.getElementById("auth-error").textContent =
              "Passwords do not match";
            document.getElementById("auth-error").classList.remove("hidden");
            return;
          }

          try {
            const endpoint = this.isLogin ? "/auth/login/" : "/auth/register/";
            const body = this.isLogin
              ? { username, password }
              : {
                  username,
                  password,
                  password_confirm: passwordConfirm,
                  email,
                };

            const data = await this.apiCall(endpoint, {
              method: "POST",
              body: JSON.stringify(body),
            });

            localStorage.setItem(
              "access_token",
              data.access_token || data.access
            );
            localStorage.setItem("username", username);
            this.user = username;
            this.showExports();
          } catch (error) {
            document.getElementById("auth-error").textContent = error.message;
            document.getElementById("auth-error").classList.remove("hidden");
          }
        }

        async handleCreate(e) {
          e.preventDefault();

          if (!this.drawnArea) {
            document.getElementById("create-error").textContent =
              "Please draw an area or upload a file";
            document.getElementById("create-error").classList.remove("hidden");
            return;
          }

          const formData = {
            name: document.getElementById("export-name").value,
            description: document.getElementById("export-desc").value,
            source: Array.from(
              document.getElementById("export-source").selectedOptions
            ).map((o) => o.value),
            output_format: Array.from(
              document.getElementById("export-format").selectedOptions
            ).map((o) => o.value),
            is_public: document.getElementById("export-public").checked,
            area_of_interest: this.drawnArea.geometry,
            source_config: {},
          };

          const microsoftSearch = document.getElementById("microsoft-search");
          if (microsoftSearch && microsoftSearch.value) {
            formData.source_config.location = microsoftSearch.value;
          }

          try {
            const result = await this.apiCall("/exports/", {
              method: "POST",
              body: JSON.stringify(formData),
            });

            this.showSuccessToast("Export created successfully!");

            this.draw.delete(this.drawnArea.id);
            this.drawnArea = null;
            this.showExports();
            this.loadExports();
          } catch (error) {
            document.getElementById("create-error").textContent = error.message;
            document.getElementById("create-error").classList.remove("hidden");
          }
        }

        handleFileUpload(e) {
          const file = e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const data = JSON.parse(event.target.result);
              let geometry = data.geometry || data;

              if (
                data.type === "FeatureCollection" &&
                data.features.length > 0
              ) {
                geometry = data.features[0].geometry;
              }

              if (geometry.type === "Polygon") {
                const feature = { type: "Feature", geometry };
                this.draw.add(feature);
                this.updateDrawnArea(feature);
              }
            } catch (error) {
              alert("Invalid file format");
            }
          };
          reader.readAsText(file);
        }

        showSuccessToast(message) {
          const toast = document.createElement("div");
          toast.className =
            "fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg z-50";
          toast.textContent = message;
          document.body.appendChild(toast);
          setTimeout(() => {
            document.body.removeChild(toast);
          }, 3000);
        }

        showErrorToast(message) {
          const toast = document.createElement("div");
          toast.className =
            "fixed bottom-4 right-4 bg-red-500 text-white px-4 py-2 rounded shadow-lg z-50";
          toast.textContent = message;
          document.body.appendChild(toast);
          setTimeout(() => {
            document.body.removeChild(toast);
          }, 4000);
        }

        logout() {
          localStorage.removeItem("access_token");
          localStorage.removeItem("username");
          this.user = null;
          this.showMine = false;
          this.showExports();
        }

        expandMap() {
          const mapContainer = document.getElementById("map");
          const fullscreenContainer = document.getElementById(
            "fullscreen-map-container"
          );
          const fullscreenModal = document.getElementById("fullscreen-map");

          mapContainer.style.height = "100%";
          mapContainer.style.width = "100%";
          fullscreenContainer.appendChild(mapContainer);
          fullscreenModal.classList.remove("hidden");

          setTimeout(() => {
            if (this.map) {
              this.map.resize();
            }
          }, 150);
        }

        closeFullscreen() {
          const mapContainer = document.getElementById("map");
          const originalContainer = document.querySelector(
            "#right-panel .flex-1"
          );
          const fullscreenModal = document.getElementById("fullscreen-map");

          mapContainer.style.height = "";
          mapContainer.style.width = "";
          originalContainer.appendChild(mapContainer);
          fullscreenModal.classList.add("hidden");

          setTimeout(() => {
            if (this.map) this.map.resize();
          }, 150);
        }

        handleMapClick(e) {
          const point = [e.point.x, e.point.y];
          
          const pmtilesLayerIds = this.pmtilesLayers
            .filter(layer => {
              const visibility = this.map.getLayoutProperty(layer.layerId, 'visibility');
              return visibility !== 'none';
            })
            .map(layer => layer.layerId);

          if (pmtilesLayerIds.length === 0) return;

          const features = this.map.queryRenderedFeatures(point, { 
            layers: pmtilesLayerIds 
          });
          
          if (features.length === 0) return;

          const layerFeatures = {};
          features.forEach((feature) => {
            const layerId = feature.layer.id;
            const layerInfo = this.pmtilesLayers.find(l => l.layerId === layerId);
            const layerName = layerInfo ? layerInfo.name : feature.layer.id.replace(/-fill$|-line$/, "");

            if (!layerFeatures[layerName]) {
              layerFeatures[layerName] = [];
            }
            layerFeatures[layerName].push(feature);
          });

          const popupContent = Object.entries(layerFeatures)
            .map(([layerName, layerFeaturesList]) => {
              const uniqueFeatures = layerFeaturesList.filter(
                (feature, idx, arr) =>
                  idx === arr.findIndex(
                    (f) => JSON.stringify(f.properties) === JSON.stringify(feature.properties)
                  )
              );

              if (uniqueFeatures.length === 0 || 
                  Object.keys(uniqueFeatures[0].properties || {}).length === 0) {
                return '';
              }

              return uniqueFeatures
                .map((feature) => {
                  const properties = feature.properties || {};
                  const propertyEntries = Object.entries(properties);
                  
                  if (propertyEntries.length === 0) return '';
                  
                  return `
                    <div class="mb-3">
                      <h3 class="font-medium text-emerald-700 mb-2">${layerName.toUpperCase()}</h3>
                      <div class="space-y-1">
                        ${propertyEntries
                          .map(([k, v]) => `<div class="text-xs"><strong>${k}:</strong> ${v}</div>`)
                          .join("")}
                      </div>
                    </div>
                  `;
                })
                .filter(content => content.length > 0)
                .join("");
            })
            .filter(content => content.length > 0)
            .join('<hr class="my-3 border-gray-200">');

          if (popupContent.trim()) {
            new maplibregl.Popup({ maxWidth: "300px" })
              .setLngLat(e.lngLat)
              .setHTML(`
                <div class="max-h-80 overflow-y-auto p-2">
                  ${popupContent}
                </div>
              `)
              .addTo(this.map);
          }
        }

        render() {
          document
            .getElementById("exports-view")
            .classList.toggle("hidden", this.currentView !== "exports");
          document
            .getElementById("auth-view")
            .classList.toggle("hidden", this.currentView !== "auth");
          document
            .getElementById("create-view")
            .classList.toggle("hidden", this.currentView !== "create");
          document
            .getElementById("detail-view")
            .classList.toggle("hidden", this.currentView !== "detail");
          document
            .getElementById("run-detail-view")
            .classList.toggle("hidden", this.currentView !== "run-detail");

          if (this.currentView === "auth") this.renderAuth();
          if (this.currentView === "exports") this.renderExports();
          if (this.currentView === "create") this.updateCreateButton();
          if (this.currentView === "detail") this.renderDetail();
          if (this.currentView === "run-detail") this.renderRunDetail();

          document
            .getElementById("logout-btn")
            .classList.toggle("hidden", !this.user);
          document
            .getElementById("login-btn")
            .classList.toggle("hidden", !!this.user);
          document
            .getElementById("signup-btn")
            .classList.toggle("hidden", !!this.user);
          document
            .getElementById("show-mine")
            .classList.toggle("hidden", !this.user);

          this.updateLayout();
          this.updateMap();
        }

        updateLayout() {
          const leftPanel = document.getElementById("left-panel");
          const rightPanel = document.getElementById("right-panel");

          if (
            this.currentView === "detail" ||
            this.currentView === "run-detail"
          ) {
            leftPanel.className = "xl:col-span-2";
            rightPanel.className = "xl:col-span-1";
          } else {
            leftPanel.className = "xl:col-span-1";
            rightPanel.className = "xl:col-span-2";
          }
        }

        renderAuth() {
          document.getElementById("auth-title").textContent = this.isLogin
            ? "Login"
            : "Sign Up";
          document.getElementById("auth-btn-text").textContent = this.isLogin
            ? "Login"
            : "Sign Up";
          document
            .getElementById("email")
            .classList.toggle("hidden", this.isLogin);
          document
            .getElementById("password-confirm")
            .classList.toggle("hidden", this.isLogin);
          document.getElementById("auth-toggle").textContent = this.isLogin
            ? "Don't have an account? Sign up"
            : "Already have an account? Login";
        }

        renderExports() {
          console.log("Rendering exports:", this.exports);

          const filtered = this.exports;

          document.getElementById("show-all").className = this.showMine
            ? "px-3 py-1 text-sm text-gray-600 hover:bg-gray-100 rounded"
            : "px-3 py-1 text-sm bg-emerald-100 text-emerald-700 rounded";
          document.getElementById("show-mine").className = this.showMine
            ? "px-3 py-1 text-sm bg-emerald-100 text-emerald-700 rounded"
            : "px-3 py-1 text-sm text-gray-600 hover:bg-gray-100 rounded";

          document.getElementById("exports-list").innerHTML = filtered.length
            ? filtered
                .map((exp) => {
                  const p = exp.properties || {};
                  const id = p.id || exp.id;

                  let status = "idle";
                  let statusColor = "gray";

                  if (p.is_processing === true) {
                    status = "processing";
                    statusColor = "yellow";
                  } else if (p.latest_run) {
                    status = p.latest_run.status || "unknown";
                    statusColor =
                      status === "completed"
                        ? "green"
                        : status === "processing"
                        ? "yellow"
                        : status === "queued"
                        ? "blue"
                        : status === "failed"
                        ? "red"
                        : "gray";
                  }

                  return `
                        <div class="export-card border rounded-lg p-4 cursor-pointer hover:bg-gray-50 bg-white shadow-sm" onclick="app.showDetail('${id}')">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-semibold truncate">${
                                  p.name || "Unnamed Export"
                                }</h4>
                                <div class="flex space-x-1">
                                    <span class="text-xs px-2 py-1 rounded ${
                                      p.is_public
                                        ? "bg-emerald-100 text-emerald-800"
                                        : "bg-gray-100 text-gray-600"
                                    }">
                                        ${p.is_public ? "Public" : "Private"}
                                    </span>
                                    <span class="text-xs px-2 py-1 rounded bg-${statusColor}-100 text-${statusColor}-800">
                                        ${status}
                                    </span>
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 mb-2">${
                              p.description || "No description"
                            }</p>
                            <div class="flex justify-between text-xs text-gray-500">
                                <span>${
                                  Array.isArray(p.source)
                                    ? p.source.join(", ")
                                    : p.source || "unknown"
                                } → ${
                    Array.isArray(p.output_format)
                      ? p.output_format.join(", ")
                      : p.output_format || "unknown"
                  }</span>
                                <span>${
                                  p.created_at
                                    ? new Date(
                                        p.created_at
                                      ).toLocaleDateString()
                                    : ""
                                }</span>
                            </div>
                        </div>
                    `;
                })
                .join("")
            : '<div class="text-center py-8 text-gray-500">No exports found</div>';
        }

        renderDetail() {
          if (!this.selectedExport) return;
          const p = this.selectedExport.properties || {};

          document.getElementById("export-details").innerHTML = `
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><span class="font-medium">Name:</span> ${
                          p.name || "Unnamed Export"
                        }</div>
                        <div><span class="font-medium">Status:</span> ${
                          p.latest_run?.status ||
                          (p.is_processing ? "processing" : "ready")
                        }</div>
                        <div><span class="font-medium">Sources:</span> ${
                          Array.isArray(p.source)
                            ? p.source.join(", ")
                            : p.source || "unknown"
                        }</div>
                        <div><span class="font-medium">Public:</span> ${
                          p.is_public ? "Yes" : "No"
                        }</div>
                        <div><span class="font-medium">Formats:</span> ${
                          Array.isArray(p.output_format)
                            ? p.output_format.join(", ")
                            : p.output_format || "unknown"
                        }</div>
                        <div><span class="font-medium">Created:</span> ${
                          p.created_at
                            ? new Date(p.created_at).toLocaleDateString()
                            : "unknown"
                        }</div>
                        <div><span class="font-medium">User:</span> ${
                          p.user?.includes("@")
                            ? p.user.split("@")[0]
                            : p.user || "unknown"
                        }</div>
                        ${
                          p.description
                            ? `<div class="col-span-2"><span class="font-medium">Description:</span> ${p.description}</div>`
                            : ""
                        }
                    </div>
                `;
        }

        renderRuns(runs) {
          document.getElementById(
            "runs-count"
          ).textContent = `${runs.length} runs`;
          document.getElementById("runs-list").innerHTML = runs.length
            ? runs
                .map(
                  (run) => `
                <div class="p-3 border rounded hover:bg-gray-50 cursor-pointer transition-colors" onclick="app.showRunDetail('${
                  run.id
                }')">
                  <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                      <span class="text-xs px-2 py-1 rounded ${
                        run.status === "completed"
                          ? "bg-green-100 text-green-800"
                          : run.status === "processing"
                          ? "bg-yellow-100 text-yellow-800"
                          : run.status === "queued"
                          ? "bg-blue-100 text-blue-800"
                          : "bg-red-100 text-red-800"
                      }">
                        ${run.status}
                      </span>
                      <span class="text-sm font-medium">#${run.id.slice(
                        -8
                      )}</span>
                    </div>
                    <div class="text-right">
                      <div class="text-xs text-gray-500">${new Date(
                        run.created_at
                      ).toLocaleDateString()}</div>
                      <div class="text-xs text-gray-400">${new Date(
                        run.created_at
                      ).toLocaleTimeString()}</div>
                    </div>
                  </div>
                  ${
                    run.status === "completed" && run.results?.sources
                      ? `<div class="mt-2 text-xs text-gray-600">
                        ${Object.keys(run.results.sources).join(", ")} • 
                        ${Object.values(run.results.sources)
                          .reduce((sum, s) => sum + (s.building_count || 0), 0)
                          .toLocaleString()} buildings
                       </div>`
                      : ""
                  }
                </div>`
                )
                .join("")
            : '<div class="text-center text-gray-500 py-8">No runs yet</div>';
        }

        showRunDetail(runId) {
          this.currentRunId = runId;
          this.currentView = "run-detail";
          this.render();
        }

        renderRunDetail() {
          if (!this.currentRunId) return;

          // Find the run data
          const runs = this.currentExportRuns || [];
          const run = runs.find((r) => r.id === this.currentRunId);

          if (!run) {
            document.getElementById("run-details").innerHTML =
              '<div class="text-red-500">Run not found</div>';
            return;
          }

          document.getElementById("run-details").innerHTML = `
            <div class="space-y-6">
              <div class="bg-gray-50 rounded-lg p-4">
                <h3 class="font-semibold mb-3">Run Information</h3>
                <div class="grid grid-cols-2 gap-4 text-sm">
                  <div>
                    <span class="text-gray-600">ID:</span>
                    <span class="font-mono ml-2">${run.id}</span>
                  </div>
                  <div>
                    <span class="text-gray-600">Status:</span>
                    <span class="ml-2 px-2 py-1 text-xs rounded ${
                      run.status === "completed"
                        ? "bg-green-100 text-green-800"
                        : run.status === "processing"
                        ? "bg-yellow-100 text-yellow-800"
                        : run.status === "queued"
                        ? "bg-blue-100 text-blue-800"
                        : "bg-red-100 text-red-800"
                    }">${run.status}</span>
                  </div>
                  <div>
                    <span class="text-gray-600">Created:</span>
                    <span class="ml-2">${new Date(
                      run.created_at
                    ).toLocaleString()}</span>
                  </div>
                  ${
                    run.completed_at
                      ? `
                  <div>
                    <span class="text-gray-600">Completed:</span>
                    <span class="ml-2">${new Date(
                      run.completed_at
                    ).toLocaleString()}</span>
                  </div>`
                      : ""
                  }
                </div>
                
                ${
                  run.status === "completed"
                    ? `
                <div class="mt-4 flex space-x-2">
                  ${
                    run.download_url
                      ? `
                  <button onclick="app.downloadRun('${
                    run.id
                  }')" class="px-2 py-1 text-xs bg-emerald-600 text-white rounded hover:bg-emerald-700">
                    Download ${
                      run.file_size
                        ? `(${(run.file_size / 1024 / 1024).toFixed(1)}MB)`
                        : ""
                    }
                  </button>`
                      : ""
                  }
                  ${
                    run.tiles_url
                      ? `
                  <button onclick="app.downloadTiles('${run.id}')" class="px-2 py-1 text-xs bg-emerald-600 text-white rounded hover:bg-emerald-700">
                    Download Tiles
                  </button>`
                      : ""
                  }
                  <button onclick="app.downloadStats('${
                    run.id
                  }')" class="px-2 py-1 text-xs bg-gray-100 rounded hover:bg-gray-200">
                    Export JSON
                  </button>
                  ${
                    run.results?.tiles_available
                      ? `
                  <button onclick="app.viewOnMap('${run.id}')" class="px-2 py-1 text-xs bg-emerald-100 text-emerald-700 rounded hover:bg-emerald-200">
                    View on Map
                  </button>`
                      : ""
                  }
                </div>`
                    : ""
                }
              </div>
              
              ${
                run.status === "completed" && run.results
                  ? this.renderSourceComparison({
                      ...run.results,
                      run_id: run.id,
                    })
                  : ""
              }
            </div>
          `;
        }

        renderSourceComparison(results) {
          if (!results?.sources) return "";
          const sources = Object.entries(results.sources);
          const totalBuildings = results.building_count || 0;
          const population = results.population?.population_estimate || 0;
          const completeness =
            results.population_stats?.source_completeness || {};

          return `
            <div class="space-y-3">
              <div class="flex justify-between items-center">
                <span class="text-sm font-medium">Analysis Results</span>
              </div>
              
              ${
                results.population
                  ? `
                <div class="bg-emerald-50 border border-emerald-200 rounded-lg p-4">
                  <div class="flex items-center justify-between mb-3">
                    <div class="font-semibold text-emerald-800 tooltip cursor-help" data-tooltip="Population estimates from WorldPop dataset for this area">Population Data</div>
                  </div>
                  <div class="grid grid-cols-2 gap-3 text-sm">
                    <div class="space-y-2">
                      <div class="flex justify-between">
                        <span class="text-emerald-700">Total People:</span>
                        <span class="font-mono font-medium">${
                          results.population.population_estimate?.toLocaleString() ||
                          "N/A"
                        }</span>
                      </div>
                      <div class="flex justify-between">
                        <span class="text-emerald-700">Area:</span>
                        <span class="font-mono">${
                          results.population.area_km2 || 0
                        } km²</span>
                      </div>
                    </div>
                    <div class="space-y-2">
                      <div class="flex justify-between">
                        <span class="text-emerald-700">Density:</span>
                        <span class="font-mono">${
                          results.population.density_per_km2 || 0
                        } ppl/km²</span>
                      </div>
                      <div class="flex justify-between">
                        <span class="text-emerald-700">Source:</span>
                        <span class="font-mono text-xs">WorldPop</span>
                      </div>
                    </div>
                  </div>
                  <div class="text-xs text-emerald-600 mt-3 p-2 bg-emerald-100 rounded">
                    <strong>Baseline:</strong> Population estimates help assess how many buildings each source should capture for complete coverage
                  </div>
                </div>`
                  : ""
              }
              
              <div class="bg-white border border-gray-200 rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                  <div class="font-semibold text-gray-800 tooltip cursor-help" data-tooltip="Individual analysis of each data source showing buildings per capita and coverage estimates">Source Coverage Analysis</div>
                </div>
                
                ${Object.entries(
                  results.population_stats.source_completeness || {}
                )
                  .map(([source, data]) => {
                    const count = data.building_count || 0;
                    const buildingsPerCapita = data.buildings_per_capita || 0;
                    const coverage = data.estimated_coverage || "unknown";
                    const sourceData =
                      sources.find(([s]) => s === source)?.[1] || {};
                    const area = sourceData.total_area_m2
                      ? (sourceData.total_area_m2 / 1000000).toFixed(1)
                      : 0;

                    let coverageLabel =
                      coverage.charAt(0).toUpperCase() +
                      coverage.slice(1).replace("_", " ");

                    return `
                    <div class="mb-3 p-3 border border-gray-100 rounded-lg hover:bg-gray-50 transition-colors">
                      <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2">
                          <div class="w-4 h-4 rounded ${this.getSourceColor(
                            source
                          )}"></div>
                          <span class="capitalize font-semibold text-gray-800">${source}</span>
                          <span class="text-xs px-2 py-1 rounded-full ${this.getCompletenessColor(
                            coverage
                          )} text-white">${coverageLabel}</span>
                        </div>
                        <div class="text-right">
                          <div class="font-mono font-bold text-lg text-emerald-700">${count.toLocaleString()}</div>
                          <div class="text-xs text-gray-500">buildings found</div>
                        </div>
                      </div>
                      <div class="grid grid-cols-2 gap-3 text-xs text-gray-600">
                        <div>
                          <span class="block font-medium tooltip cursor-help" data-tooltip="Total area covered by buildings from this source">Coverage Area</span>
                          <span class="font-mono">${area} km²</span>
                        </div>
                        <div class="tooltip cursor-help" data-tooltip="Calculation: (${count.toLocaleString()} buildings ÷ ${
                      population?.toLocaleString() || "N/A"
                    } people) × 1000 = ${buildingsPerCapita}">
                          <span class="block font-medium">Buildings per 1K people</span>
                          <span class="font-mono text-emerald-600 font-medium">${buildingsPerCapita}</span>
                        </div>
                      </div>
                    </div>`;
                  })
                  .join("")}
                
                <div class="mt-4 text-xs text-gray-600 p-3 bg-gray-50 rounded-lg">
                  <strong>Calculation:</strong> Buildings per 1K people = (Building Count ÷ Population) × 1000
                  <br><strong>Coverage Assessment:</strong> Based on raw ratio (Building Count ÷ Population):
                  <div class="mt-2 grid grid-cols-2 gap-2 text-xs">
                    <div><span class="text-red-600">●</span> Very Low: &lt;0.1 (less than 1 building per 10 people)</div>
                    <div><span class="text-orange-500">●</span> Low: 0.1-0.2 (1 building per 5-10 people)</div>
                    <div><span class="text-yellow-500">●</span> Moderate: 0.2-0.4 (1 building per 2.5-5 people)</div>
                    <div><span class="text-emerald-500">●</span> High: 0.4-0.6 (1 building per 1.7-2.5 people)</div>
                    <div><span class="text-emerald-600">●</span> Excellent: &gt;0.6 (more than 1 building per 1.7 people)</div>
                  </div>
                  <br><strong>Analysis:</strong> Each source is evaluated independently based on buildings found relative to population estimates
                </div>
              </div>
            </div>`;
        }

        getSourceColor(source) {
          const colors = {
            osm: "bg-emerald-500",
            google: "bg-emerald-600",
            microsoft: "bg-emerald-400",
            overture: "bg-emerald-700",
          };
          return colors[source] || "bg-emerald-500";
        }

        getCompletenessColor(coverage) {
          const colors = {
            excellent: "bg-emerald-600",
            high: "bg-emerald-500",
            moderate: "bg-yellow-500",
            low: "bg-orange-500",
            very_low: "bg-red-500",
          };
          return colors[coverage] || "bg-gray-500";
        }

        async rerunExport(exportId) {
          try {
            await this.apiCall(`/exports/rerun/${exportId}/`, {
              method: "POST",
            });
            this.showSuccessToast("Export rerun started!");
            this.loadExportRuns(exportId);
          } catch (error) {
            console.error("Failed to rerun export:", error);
            this.showErrorToast(error.message);
          }
        }

        async downloadRun(runId) {
          try {
            const token = localStorage.getItem("access_token");
            let downloadUrl = `/api/runs/${runId}/download/`;
            let headers = {};

            if (!token) {
              downloadUrl = `/api/public/runs/${runId}/download/`;
            } else {
              headers["Authorization"] = `Bearer ${token}`;
            }

            const response = await fetch(downloadUrl, { headers });
            if (!response.ok && token) {
              const publicResponse = await fetch(
                `/api/public/runs/${runId}/download/`
              );
              if (publicResponse.ok) {
                const blob = await publicResponse.blob();
                this.triggerDownload(blob, runId);
                return;
              }
            }

            if (!response.ok) {
              throw new Error("Download failed");
            }

            const blob = await response.blob();
            this.triggerDownload(blob, runId);
          } catch (error) {
            console.error("Failed to download:", error);
            this.showErrorToast("Download failed");
          }
        }

        triggerDownload(blob, runId) {
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `export-${runId}.zip`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
          this.showSuccessToast("Download started!");
        }

        async downloadStats(runId) {
          try {
            const data = await this.apiCall(`/runs/${runId}/stats/`);

            const blob = new Blob([JSON.stringify(data, null, 2)], {
              type: "application/json",
            });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `stats-${runId}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            this.showSuccessToast("Stats downloaded!");
          } catch (error) {
            console.error("Failed to download stats:", error);
            this.showErrorToast("Stats download failed");
          }
        }

        async viewOnMap(runId) {
          try {
            const headers = {};
            const token = localStorage.getItem("token");
            if (token) {
              headers["Authorization"] = `Token ${token}`;
            }

            let tilesUrl = `/api/runs/${runId}/tiles/`;
            const response = await fetch(tilesUrl, { headers });

            if (!response.ok) {
              if (response.status === 401 && !token) {
                tilesUrl = `/api/public/runs/${runId}/tiles/`;
                const publicResponse = await fetch(tilesUrl);
                if (!publicResponse.ok) {
                  throw new Error("Tiles not available");
                }
              } else {
                throw new Error("Tiles not available");
              }
            }

            this.loadTilesOnMap(runId, tilesUrl);
            this.showSuccessToast("Tiles loaded on map!");
          } catch (error) {
            console.error("Failed to load tiles:", error);
            this.showErrorToast("Tiles not available");
          }
        }

        loadTilesOnMap(runId, tilesUrl) {
          if (!this.map) return;
          const sourceId = `tiles-${runId}`;

          if (this.map.getSource(sourceId)) {
            const layers = this.map.getStyle().layers;
            layers.forEach((layer) => {
              if (layer.source === sourceId) this.map.removeLayer(layer.id);
            });
            this.map.removeSource(sourceId);
          }

          this.map.addSource(sourceId, {
            type: "vector",
            url: `pmtiles://${window.location.origin}${tilesUrl}`,
          });

          this.loadPMTilesLayers(sourceId, runId, tilesUrl);
        }

        async loadPMTilesLayers(sourceId, runId, tilesUrl) {
          try {
            const pmtilesUrl = `${window.location.origin}${tilesUrl}`;
            const pmtilesInstance = new pmtiles.PMTiles(pmtilesUrl);
            const metadata = await pmtilesInstance.getMetadata();

            const colors = [
              "#e74c3c",
              "#3498db",
              "#9b59b6",
              "#2ecc71",
              "#f39c12",
              "#e67e22",
              "#1abc9c",
              "#34495e",
            ];
            const addedLayers = [];

            if (metadata.vector_layers) {
              for (const vectorLayer of metadata.vector_layers) {
                const layerName = vectorLayer.id;
                const layerId = `${layerName}-${runId}`;
                const color = colors[Math.floor(Math.random() * colors.length)];

                try {
                  this.map.addLayer({
                    id: layerId,
                    type: "fill",
                    source: sourceId,
                    "source-layer": layerName,
                    paint: { "fill-color": color, "fill-opacity": 0.15 },
                  });
                  this.map.addLayer({
                    id: `${layerId}-outline`,
                    type: "line",
                    source: sourceId,
                    "source-layer": layerName,
                    paint: {
                      "line-color": color,
                      "line-width": 1,
                      "line-opacity": 1,
                    },
                  });

                  addedLayers.push({ name: layerName, layerId, color });
                  this.pmtilesLayers.push({ name: layerName, layerId, color, sourceId });

                  this.map.on(
                    "mouseenter",
                    layerId,
                    () => (this.map.getCanvas().style.cursor = "pointer")
                  );
                  this.map.on(
                    "mouseleave",
                    layerId,
                    () => (this.map.getCanvas().style.cursor = "")
                  );
                } catch (error) {
                  console.log(`Failed to add layer ${layerName}:`, error);
                }
              }
            } else {
              console.log(
                "No vector_layers found in metadata, falling back to default layer"
              );
              const layerId = `buildings-${runId}`;
              const color = sourceColors.buildings;

              this.map.addLayer({
                id: layerId,
                type: "fill",
                source: sourceId,
                "source-layer": "buildings",
                paint: { "fill-color": color, "fill-opacity": 0.6 },
              });
              addedLayers.push({ name: "buildings", layerId, color });
              this.pmtilesLayers.push({ name: "buildings", layerId, color, sourceId });
            }

            this.updateLayerSwitcher(addedLayers);
          } catch (error) {
            console.error("Failed to load PMTiles metadata:", error);
            this.fallbackToStaticLayers(sourceId, runId);
          }
        }

        fallbackToStaticLayers(sourceId, runId) {
          const colors = [
            "#e74c3c",
            "#3498db",
            "#9b59b6",
            "#2ecc71",
            "#f39c12",
            "#e67e22",
            "#1abc9c",
            "#34495e",
          ];
          const possibleSources = [
            "osm",
            "google",
            "overture",
            "microsoft",
            "buildings",
          ];
          const addedLayers = [];

          possibleSources.forEach((sourceName) => {
            const layerId = `${sourceName}-${runId}`;
            const color = colors[Math.floor(Math.random() * colors.length)];

            try {
              this.map.addLayer({
                id: layerId,
                type: "fill",
                source: sourceId,
                "source-layer": sourceName,
                paint: { "fill-color": color, "fill-opacity": 0.15 },
              });
              this.map.addLayer({
                id: `${layerId}-outline`,
                type: "line",
                source: sourceId,
                "source-layer": sourceName,
                paint: {
                  "line-color": color,
                  "line-width": 2,
                  "line-opacity": 1,
                },
              });

              addedLayers.push({ name: sourceName, layerId, color });

              this.map.on(
                "mouseenter",
                layerId,
                () => (this.map.getCanvas().style.cursor = "pointer")
              );
              this.map.on(
                "mouseleave",
                layerId,
                () => (this.map.getCanvas().style.cursor = "")
              );
            } catch (error) {
              console.log(`Layer ${sourceName} not found`);
            }
          });
          this.updateLayerSwitcher(addedLayers);
        }

        updateLayerSwitcher(layers) {
          const existingSwitcher = document.getElementById("layer-switcher");
          if (existingSwitcher) existingSwitcher.remove();
          if (layers.length === 0) return;

          const switcher = document.createElement("div");
          switcher.id = "layer-switcher";
          switcher.className =
            "absolute top-4 right-4 bg-white p-3 rounded-lg shadow-lg z-10 min-w-40";
          switcher.innerHTML = `
            <h4 class="font-medium text-sm mb-3">Building Sources</h4>
            ${layers
              .map(
                (layer) => `
              <label class="flex items-center mb-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                <input type="checkbox" id="layer-${layer.layerId}" checked 
                       class="mr-2" onchange="app.toggleLayer('${
                         layer.layerId
                       }')">
                <div class="w-3 h-3 mr-2 rounded-sm" style="background-color: ${
                  layer.color
                }"></div>
                <span class="text-xs font-medium">${layer.name.toUpperCase()}</span>
              </label>`
              )
              .join("")}`;

          const mapContainer = document.getElementById("map");
          if (mapContainer) mapContainer.appendChild(switcher);
        }

        toggleLayer(layerId) {
          const checkbox = document.getElementById(`layer-${layerId}`);
          const visibility = checkbox.checked ? "visible" : "none";

          if (this.map.getLayer(layerId)) {
            this.map.setLayoutProperty(layerId, "visibility", visibility);
          }
          if (this.map.getLayer(`${layerId}-outline`)) {
            this.map.setLayoutProperty(
              `${layerId}-outline`,
              "visibility",
              visibility
            );
          }
        }

        async downloadTiles(runId) {
          try {
            const headers = {};
            const token = localStorage.getItem("token");
            if (token) {
              headers["Authorization"] = `Token ${token}`;
            }

            let tilesUrl = `/api/runs/${runId}/tiles/`;
            const response = await fetch(tilesUrl, { headers });

            if (!response.ok) {
              if (response.status === 401 && !token) {
                tilesUrl = `/api/public/runs/${runId}/tiles/`;
                const publicResponse = await fetch(tilesUrl);
                if (publicResponse.ok) {
                  const blob = await publicResponse.blob();
                  this.triggerTilesDownload(blob, runId);
                  return;
                }
              }
              throw new Error("Tiles download failed");
            }

            const blob = await response.blob();
            this.triggerTilesDownload(blob, runId);
          } catch (error) {
            console.error("Failed to download tiles:", error);
            this.showErrorToast("Tiles download failed");
          }
        }

        triggerTilesDownload(blob, runId) {
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `tiles-${runId}.pmtiles`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
          this.showSuccessToast("Tiles download started!");
        }

        handleUrlRouting() {
          const path = window.location.pathname;
          const match = path.match(/^\/public\/([^\/]+)\/?$/);

          if (match) {
            const exportId = match[1];
            this.loadPublicExport(exportId);
          }
        }

        async loadPublicExport(exportId) {
          try {
            const export_data = await fetch(`/api/public/exports/${exportId}/`);
            const export_json = await export_data.json();

            if (export_json) {
              this.exports = [export_json];
              this.selectedExport = export_json;
              this.currentView = "detail";
              this.render();
              this.loadPublicExportRuns(exportId);
            }
          } catch (error) {
            console.error("Failed to load public export:", error);
            this.showErrorToast("Export not found or not public");
          }
        }

        async loadPublicExportRuns(exportId) {
          try {
            const data = await fetch(`/api/public/exports/${exportId}/runs/`);
            const runs = await data.json();
            this.renderRuns(runs.results || []);
          } catch (error) {
            console.error("Failed to load public runs:", error);
          }
        }

        showErrorToast(message) {
          const toast = document.createElement("div");
          toast.className =
            "fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded shadow-lg z-50";
          toast.textContent = message;
          document.body.appendChild(toast);
          setTimeout(() => {
            document.body.removeChild(toast);
          }, 3000);
        }

        showInfoToast(message) {
          const toast = document.createElement("div");
          toast.className =
            "fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded shadow-lg z-50";
          toast.textContent = message;
          document.body.appendChild(toast);
          setTimeout(() => {
            document.body.removeChild(toast);
          }, 3000);
        }

        updateMap() {
          ["exports-fill", "exports-stroke"].forEach((id) => {
            if (this.map.getLayer(id)) this.map.removeLayer(id);
          });
          if (this.map.getSource("exports")) this.map.removeSource("exports");

          let filtered = [];
          if (this.currentView === "detail" && this.selectedExport) {
            filtered = [this.selectedExport];
          } else {
            filtered = this.exports;
          }

          if (filtered.length > 0) {
            console.log("Adding", filtered.length, "exports to map:", filtered);

            this.map.addSource("exports", {
              type: "geojson",
              data: { type: "FeatureCollection", features: filtered },
            });

            this.map.addLayer({
              id: "exports-fill",
              type: "fill",
              source: "exports",
              paint: { "fill-color": "#10b981", "fill-opacity": 0.2 },
            });

            this.map.addLayer({
              id: "exports-stroke",
              type: "line",
              source: "exports",
              paint: { "line-color": "#059669", "line-width": 2 },
            });

            const allCoords = filtered.flatMap(
              (f) => f.geometry?.coordinates?.[0] || []
            );
            if (allCoords.length > 0) {
              const bounds = allCoords.reduce(
                (b, coord) => b.extend(coord),
                new maplibregl.LngLatBounds(allCoords[0], allCoords[0])
              );
              this.map.fitBounds(bounds, { padding: 50 });
            }
          }
        }
      }

      const app = new OBEApp();
    </script>
  </body>
</html>
