<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OBE - Open Building Exports</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css"
    />
    <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
    <script src="https://unpkg.com/pmtiles@3.0.7/dist/pmtiles.js"></script>
    <script src="https://unpkg.com/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.js"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.css"
    />
    <style>
      .maplibregl-ctrl-top-right {
        z-index: 2;
      }
      .maplibregl-draw-polygon.maplibregl-draw-active {
        cursor: crosshair;
      }
      .search-dropdown {
        max-height: 200px;
        overflow-y: auto;
      }
      #map {
        height: 70vh;
        min-height: 400px;
      }
      @media (max-width: 768px) {
        #map {
          height: 50vh;
          min-height: 300px;
        }
        .grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <div class="bg-white shadow-sm border-b">
      <div
        class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center"
      >
        <h1
          class="text-2xl font-bold text-emerald-600 cursor-pointer"
          onclick="app.showExports()"
        >
          OBE
        </h1>
        <div id="auth-buttons" class="flex space-x-3">
          <button
            id="login-btn"
            class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded"
          >
            Login
          </button>
          <button
            id="signup-btn"
            class="px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700"
          >
            Sign Up
          </button>
          <button
            id="logout-btn"
            class="hidden px-4 py-2 text-gray-600 hover:bg-gray-100 rounded"
          >
            Logout
          </button>
        </div>
      </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 py-6">
      <div id="main-grid" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div id="left-panel" class="lg:col-span-1">
          <div class="bg-white rounded-lg shadow-sm">
            <div id="exports-view" class="p-6">
              <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold">Exports</h2>
                <div class="flex space-x-2">
                  <button
                    id="show-all"
                    class="px-3 py-1 text-sm bg-emerald-100 text-emerald-700 rounded"
                  >
                    All
                  </button>
                  <button
                    id="show-mine"
                    class="hidden px-3 py-1 text-sm text-gray-600 hover:bg-gray-100 rounded"
                  >
                    Mine
                  </button>
                  <button
                    id="create-new"
                    class="px-3 py-1 text-sm bg-emerald-600 text-white rounded hover:bg-emerald-700"
                  >
                    + New
                  </button>
                </div>
              </div>
              <div
                id="exports-list"
                class="space-y-3 max-h-96 overflow-y-auto"
              ></div>
            </div>

            <div id="auth-view" class="hidden p-6">
              <h2 id="auth-title" class="text-xl font-semibold mb-6">Login</h2>
              <form id="auth-form" class="space-y-4">
                <input
                  id="username"
                  type="text"
                  placeholder="Username"
                  required
                  class="w-full px-3 py-2 border rounded focus:border-emerald-500"
                />
                <input
                  id="email"
                  type="email"
                  placeholder="Email"
                  class="hidden w-full px-3 py-2 border rounded focus:border-emerald-500"
                />
                <input
                  id="password"
                  type="password"
                  placeholder="Password"
                  required
                  class="w-full px-3 py-2 border rounded focus:border-emerald-500"
                />
                <input
                  id="password-confirm"
                  type="password"
                  placeholder="Confirm Password"
                  class="hidden w-full px-3 py-2 border rounded focus:border-emerald-500"
                />
                <div id="auth-error" class="hidden text-red-600 text-sm"></div>
                <div class="flex space-x-3">
                  <button
                    type="submit"
                    class="flex-1 bg-emerald-600 text-white py-2 rounded hover:bg-emerald-700"
                  >
                    <span id="auth-btn-text">Login</span>
                  </button>
                  <button
                    type="button"
                    id="auth-cancel"
                    class="flex-1 bg-gray-300 text-gray-700 py-2 rounded hover:bg-gray-400"
                  >
                    Cancel
                  </button>
                </div>
                <button
                  type="button"
                  id="auth-toggle"
                  class="w-full text-sm text-emerald-600 hover:text-emerald-700"
                >
                  Don't have an account? Sign up
                </button>
              </form>
            </div>

            <div id="create-view" class="hidden p-6">
              <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold">Create Export</h2>
                <button
                  id="create-cancel"
                  class="text-gray-500 hover:text-gray-700"
                >
                  ✕
                </button>
              </div>
              <div
                id="draw-status"
                class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-800"
              >
                Draw area on map or upload file
              </div>
              <form id="create-form" class="space-y-4">
                <input
                  id="export-name"
                  type="text"
                  placeholder="Export name"
                  required
                  class="w-full px-3 py-2 border rounded focus:border-emerald-500"
                />
                <textarea
                  id="export-desc"
                  placeholder="Description (optional)"
                  class="w-full px-3 py-2 border rounded focus:border-emerald-500 h-16"
                ></textarea>
                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="block text-sm font-medium mb-1">Source</label>
                    <select
                      id="export-source"
                      multiple
                      class="w-full px-3 py-2 border rounded focus:border-emerald-500 h-20 text-sm"
                    >
                      <option value="google">Google</option>
                      <option value="microsoft">Microsoft</option>
                      <option value="osm">OpenStreetMap</option>
                      <option value="overture">Overture</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-1">Format</label>
                    <select
                      id="export-format"
                      multiple
                      class="w-full px-3 py-2 border rounded focus:border-emerald-500 h-20 text-sm"
                    >
                      <option value="geoparquet">GeoParquet</option>
                      <option value="geojson">GeoJSON</option>
                      <option value="shapefile">Shapefile</option>
                      <option value="geopackage">GeoPackage</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">
                      Vector tiles generated automatically for web viewing
                    </p>
                  </div>
                </div>
                <div id="source-configs" class="space-y-3"></div>
                <div class="flex items-center space-x-2">
                  <input id="export-public" type="checkbox" class="rounded" />
                  <label class="text-sm">Make public</label>
                </div>
                <div
                  class="border-2 border-dashed border-gray-300 rounded p-4 text-center"
                >
                  <input
                    type="file"
                    id="file-upload"
                    accept=".geojson,.json,.kml,.gpx"
                    class="hidden"
                  />
                  <button
                    type="button"
                    id="upload-btn"
                    class="text-emerald-600 hover:text-emerald-700"
                  >
                    Upload boundary file
                  </button>
                  <p class="text-xs text-gray-500 mt-1">GeoJSON, KML, GPX</p>
                </div>
                <div
                  id="create-error"
                  class="hidden text-red-600 text-sm"
                ></div>
                <button
                  type="submit"
                  id="create-submit"
                  disabled
                  class="w-full bg-gray-400 text-white py-2 rounded cursor-not-allowed"
                >
                  Create Export
                </button>
              </form>
            </div>

            <div id="detail-view" class="hidden p-6">
              <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold">Export Details</h2>
                <button
                  id="detail-cancel"
                  class="text-gray-500 hover:text-gray-700"
                >
                  ✕
                </button>
              </div>
              <div id="export-details"></div>
              <div id="runs-list" class="mt-6"></div>
            </div>
          </div>
        </div>

        <div id="right-panel" class="lg:col-span-2">
          <div class="bg-white rounded-lg shadow-sm p-4">
            <div id="map" class="w-full rounded border"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      class OBEApp {
        constructor() {
          this.exports = [];
          this.user = null;
          this.showMine = false;
          this.currentView = "exports";
          this.drawnArea = null;
          this.isLogin = true;
          this.countries = [];
          this.selectedExport = null;
          this.currentRunId = null;
          this.init();
        }

        async init() {
          let protocol = new pmtiles.Protocol();
          maplibregl.addProtocol("pmtiles", protocol.tile);

          await this.loadCountries();
          this.map = new maplibregl.Map({
            container: "map",
            style:
              "https://basemaps.cartocdn.com/gl/positron-gl-style/style.json",
            center: [0, 20],
            zoom: 2,
          });

          this.map.on("load", () => {
            this.draw = new MapboxDraw({
              displayControlsDefault: false,
              controls: { polygon: true, trash: true },
              defaultMode: "simple_select",
            });
            this.map.addControl(this.draw, "top-right");
            this.map.on("draw.create", (e) =>
              this.updateDrawnArea(e.features[0])
            );
            this.map.on("draw.update", (e) =>
              this.updateDrawnArea(e.features[0])
            );
            this.map.on("draw.delete", () => this.updateDrawnArea(null));
          });

          this.setupEvents();
          this.handleUrlRouting();
          this.checkAuth();
          this.loadExports();
        }

        async loadCountries() {
          try {
            const response = await fetch(
              "https://raw.githubusercontent.com/kshitijrajsharma/global-boundaries-bbox/refs/heads/main/countries.json"
            );
            this.countries = await response.json();
          } catch (error) {
            console.error("Failed to load countries:", error);
            this.countries = [];
          }
        }

        async apiCall(endpoint, options = {}) {
          const token = localStorage.getItem("access_token");
          const headers = { "Content-Type": "application/json" };
          if (token) headers.Authorization = `Bearer ${token}`;

          const response = await fetch(`/api${endpoint}`, {
            ...options,
            headers: { ...headers, ...options.headers },
          });

          if (!response.ok) {
            const data = await response.json();
            throw new Error(data.detail || "Request failed");
          }
          return await response.json();
        }

        checkAuth() {
          const token = localStorage.getItem("access_token");
          const username = localStorage.getItem("username");
          if (token && username) this.user = username;
          this.render();
        }

        async loadExports() {
          try {
            let data;
            if (this.showMine && this.user) {
              data = await this.apiCall("/exports/?ordering=-created_at");
            } else {
              data = await this.apiCall(
                "/public/exports/?ordering=-created_at"
              );
            }
            this.exports = data.results?.features || data.features || [];
            console.log("Loaded exports:", this.exports);
          } catch (error) {
            console.error("Failed to load exports:", error);
            this.exports = [];
          }
          this.render();
        }

        setupEvents() {
          document.getElementById("login-btn").onclick = () =>
            this.showAuth(true);
          document.getElementById("signup-btn").onclick = () =>
            this.showAuth(false);
          document.getElementById("logout-btn").onclick = () => this.logout();
          document.getElementById("show-all").onclick = () =>
            this.toggleFilter(false);
          document.getElementById("show-mine").onclick = () =>
            this.toggleFilter(true);
          document.getElementById("create-new").onclick = () =>
            this.showCreate();
          document.getElementById("auth-cancel").onclick = () =>
            this.showExports();
          document.getElementById("auth-toggle").onclick = () =>
            this.toggleAuthMode();
          document.getElementById("create-cancel").onclick = () =>
            this.showExports();
          document.getElementById("detail-cancel").onclick = () =>
            this.showExports();
          document.getElementById("export-source").onchange = () =>
            this.updateSourceConfigs();
          document.getElementById("upload-btn").onclick = () =>
            document.getElementById("file-upload").click();
          document.getElementById("file-upload").onchange = (e) =>
            this.handleFileUpload(e);
          document.getElementById("auth-form").onsubmit = (e) =>
            this.handleAuth(e);
          document.getElementById("create-form").onsubmit = (e) =>
            this.handleCreate(e);
        }

        showAuth(isLogin) {
          this.isLogin = isLogin;
          this.currentView = "auth";
          this.render();
        }

        showExports() {
          this.currentView = "exports";
          this.selectedExport = null;
          this.render();
        }

        showCreate() {
          if (!this.user) {
            this.showAuth(true);
            return;
          }
          this.currentView = "create";
          if (this.draw) this.draw.changeMode("draw_polygon");
          this.render();
        }

        showDetail(exportId) {
          this.selectedExport = this.exports.find(
            (e) => (e.properties?.id || e.id) === exportId
          );
          this.currentView = "detail";
          this.render();
          this.loadExportRuns(exportId);
        }

        async loadExportRuns(exportId) {
          try {
            const data = await this.apiCall(`/exports/${exportId}/runs/`);
            this.renderRuns(data.results || []);
          } catch (error) {
            console.error("Failed to load runs:", error);
          }
        }

        toggleFilter(mine) {
          this.showMine = mine;
          this.loadExports();
        }

        toggleAuthMode() {
          this.isLogin = !this.isLogin;
          this.render();
        }

        updateSourceConfigs() {
          const sourceSelect = document.getElementById("export-source");
          const configContainer = document.getElementById("source-configs");
          const selectedSources = Array.from(sourceSelect.selectedOptions).map(
            (option) => option.value
          );

          configContainer.innerHTML = "";

          selectedSources.forEach((source) => {
            if (source === "microsoft") {
              configContainer.innerHTML += `
                            <div class="microsoft-config">
                                <label class="block text-sm font-medium mb-1">Microsoft Location</label>
                                <div class="relative">
                                    <input id="microsoft-search" type="text" placeholder="Search country..." class="w-full px-3 py-2 border rounded focus:border-emerald-500">
                                    <div id="microsoft-dropdown" class="hidden absolute z-10 w-full bg-white border rounded-b shadow-lg search-dropdown">
                                        ${this.countries
                                          .map(
                                            (country) =>
                                              `<div class="px-3 py-2 hover:bg-gray-100 cursor-pointer country-option" data-value="${country.shapeName}">${country.shapeName}</div>`
                                          )
                                          .join("")}
                                    </div>
                                </div>
                            </div>
                        `;

              setTimeout(() => {
                const searchInput = document.getElementById("microsoft-search");
                const dropdown = document.getElementById("microsoft-dropdown");
                searchInput.onfocus = () => dropdown.classList.remove("hidden");
                searchInput.onblur = () =>
                  setTimeout(() => dropdown.classList.add("hidden"), 200);
                searchInput.oninput = (e) =>
                  this.filterCountries(e.target.value);
                dropdown.onclick = (e) => {
                  if (e.target.classList.contains("country-option")) {
                    searchInput.value = e.target.dataset.value;
                    dropdown.classList.add("hidden");
                  }
                };
              }, 100);
            }
          });
        }

        filterCountries(query) {
          const options = document.querySelectorAll(".country-option");
          options.forEach((option) => {
            const matches = option.textContent
              .toLowerCase()
              .includes(query.toLowerCase());
            option.style.display = matches ? "block" : "none";
          });
        }

        updateDrawnArea(area) {
          this.drawnArea = area;
          if (this.currentView === "create") this.updateCreateButton();
        }

        updateCreateButton() {
          const btn = document.getElementById("create-submit");
          const status = document.getElementById("draw-status");

          if (this.drawnArea) {
            btn.disabled = false;
            btn.className =
              "w-full bg-emerald-600 text-white py-2 rounded hover:bg-emerald-700";
            status.innerHTML = "Area selected";
            status.className =
              "mb-4 p-3 bg-green-50 border border-green-200 rounded text-sm text-green-800";
          } else {
            btn.disabled = true;
            btn.className =
              "w-full bg-gray-400 text-white py-2 rounded cursor-not-allowed";
            status.innerHTML = "Draw area on map or upload file";
            status.className =
              "mb-4 p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-800";
          }
        }

        async handleAuth(e) {
          e.preventDefault();
          const username = document.getElementById("username").value;
          const password = document.getElementById("password").value;
          const passwordConfirm =
            document.getElementById("password-confirm").value;
          const email = document.getElementById("email").value;

          // Clear any previous errors
          document.getElementById("auth-error").classList.add("hidden");

          // Validate password confirmation for signup
          if (!this.isLogin && password !== passwordConfirm) {
            document.getElementById("auth-error").textContent =
              "Passwords do not match";
            document.getElementById("auth-error").classList.remove("hidden");
            return;
          }

          try {
            const endpoint = this.isLogin ? "/auth/login/" : "/auth/register/";
            const body = this.isLogin
              ? { username, password }
              : {
                  username,
                  password,
                  password_confirm: passwordConfirm,
                  email,
                };

            const data = await this.apiCall(endpoint, {
              method: "POST",
              body: JSON.stringify(body),
            });

            localStorage.setItem(
              "access_token",
              data.access_token || data.access
            );
            localStorage.setItem("username", username);
            this.user = username;
            this.showExports();
          } catch (error) {
            document.getElementById("auth-error").textContent = error.message;
            document.getElementById("auth-error").classList.remove("hidden");
          }
        }

        async handleCreate(e) {
          e.preventDefault();

          if (!this.drawnArea) {
            document.getElementById("create-error").textContent =
              "Please draw an area or upload a file";
            document.getElementById("create-error").classList.remove("hidden");
            return;
          }

          const formData = {
            name: document.getElementById("export-name").value,
            description: document.getElementById("export-desc").value,
            source: Array.from(
              document.getElementById("export-source").selectedOptions
            ).map((o) => o.value),
            output_format: Array.from(
              document.getElementById("export-format").selectedOptions
            ).map((o) => o.value),
            is_public: document.getElementById("export-public").checked,
            area_of_interest: this.drawnArea.geometry,
            source_config: {},
          };

          const microsoftSearch = document.getElementById("microsoft-search");
          if (microsoftSearch && microsoftSearch.value) {
            formData.source_config.location = microsoftSearch.value;
          }

          try {
            const result = await this.apiCall("/exports/", {
              method: "POST",
              body: JSON.stringify(formData),
            });

            this.showSuccessToast("Export created successfully!");

            this.draw.delete(this.drawnArea.id);
            this.drawnArea = null;
            this.showExports();
            this.loadExports();
          } catch (error) {
            document.getElementById("create-error").textContent = error.message;
            document.getElementById("create-error").classList.remove("hidden");
          }
        }

        handleFileUpload(e) {
          const file = e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const data = JSON.parse(event.target.result);
              let geometry = data.geometry || data;

              if (
                data.type === "FeatureCollection" &&
                data.features.length > 0
              ) {
                geometry = data.features[0].geometry;
              }

              if (geometry.type === "Polygon") {
                const feature = { type: "Feature", geometry };
                this.draw.add(feature);
                this.updateDrawnArea(feature);
              }
            } catch (error) {
              alert("Invalid file format");
            }
          };
          reader.readAsText(file);
        }

        showSuccessToast(message) {
          const toast = document.createElement("div");
          toast.className =
            "fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg z-50";
          toast.textContent = message;
          document.body.appendChild(toast);
          setTimeout(() => {
            document.body.removeChild(toast);
          }, 3000);
        }

        logout() {
          localStorage.removeItem("access_token");
          localStorage.removeItem("username");
          this.user = null;
          this.showMine = false;
          this.showExports();
        }

        render() {
          document
            .getElementById("exports-view")
            .classList.toggle("hidden", this.currentView !== "exports");
          document
            .getElementById("auth-view")
            .classList.toggle("hidden", this.currentView !== "auth");
          document
            .getElementById("create-view")
            .classList.toggle("hidden", this.currentView !== "create");
          document
            .getElementById("detail-view")
            .classList.toggle("hidden", this.currentView !== "detail");

          if (this.currentView === "auth") this.renderAuth();
          if (this.currentView === "exports") this.renderExports();
          if (this.currentView === "create") this.updateCreateButton();
          if (this.currentView === "detail") this.renderDetail();

          document
            .getElementById("logout-btn")
            .classList.toggle("hidden", !this.user);
          document
            .getElementById("login-btn")
            .classList.toggle("hidden", !!this.user);
          document
            .getElementById("signup-btn")
            .classList.toggle("hidden", !!this.user);
          document
            .getElementById("show-mine")
            .classList.toggle("hidden", !this.user);

          // Adjust layout based on current view
          this.updateLayout();
          this.updateMap();
        }

        updateLayout() {
          const leftPanel = document.getElementById("left-panel");
          const rightPanel = document.getElementById("right-panel");

          if (this.currentView === "detail") {
            // For detail view, give more space to the left panel
            leftPanel.className = "lg:col-span-2";
            rightPanel.className = "lg:col-span-1";
          } else {
            // For other views, standard layout
            leftPanel.className = "lg:col-span-1";
            rightPanel.className = "lg:col-span-2";
          }
        }

        renderAuth() {
          document.getElementById("auth-title").textContent = this.isLogin
            ? "Login"
            : "Sign Up";
          document.getElementById("auth-btn-text").textContent = this.isLogin
            ? "Login"
            : "Sign Up";
          document
            .getElementById("email")
            .classList.toggle("hidden", this.isLogin);
          document
            .getElementById("password-confirm")
            .classList.toggle("hidden", this.isLogin);
          document.getElementById("auth-toggle").textContent = this.isLogin
            ? "Don't have an account? Sign up"
            : "Already have an account? Login";
        }

        renderExports() {
          console.log("Rendering exports:", this.exports);

          const filtered = this.exports;

          document.getElementById("show-all").className = this.showMine
            ? "px-3 py-1 text-sm text-gray-600 hover:bg-gray-100 rounded"
            : "px-3 py-1 text-sm bg-emerald-100 text-emerald-700 rounded";
          document.getElementById("show-mine").className = this.showMine
            ? "px-3 py-1 text-sm bg-emerald-100 text-emerald-700 rounded"
            : "px-3 py-1 text-sm text-gray-600 hover:bg-gray-100 rounded";

          document.getElementById("exports-list").innerHTML = filtered.length
            ? filtered
                .map((exp) => {
                  const p = exp.properties || {};
                  const id = p.id || exp.id;

                  // Determine processing status and color
                  let status = "idle";
                  let statusColor = "gray";

                  if (p.is_processing === true) {
                    status = "processing";
                    statusColor = "yellow";
                  } else if (p.latest_run) {
                    status = p.latest_run.status || "unknown";
                    statusColor =
                      status === "completed"
                        ? "green"
                        : status === "processing"
                        ? "yellow"
                        : status === "queued"
                        ? "blue"
                        : status === "failed"
                        ? "red"
                        : "gray";
                  }

                  return `
                        <div class="border rounded p-3 cursor-pointer hover:bg-gray-50" onclick="app.showDetail('${id}')">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-semibold truncate">${
                                  p.name || "Unnamed Export"
                                }</h4>
                                <div class="flex space-x-1">
                                    <span class="text-xs px-2 py-1 rounded ${
                                      p.is_public
                                        ? "bg-emerald-100 text-emerald-800"
                                        : "bg-gray-100 text-gray-600"
                                    }">
                                        ${p.is_public ? "Public" : "Private"}
                                    </span>
                                    <span class="text-xs px-2 py-1 rounded bg-${statusColor}-100 text-${statusColor}-800">
                                        ${status}
                                    </span>
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 mb-2">${
                              p.description || "No description"
                            }</p>
                            <div class="flex justify-between text-xs text-gray-500">
                                <span>${
                                  Array.isArray(p.source)
                                    ? p.source.join(", ")
                                    : p.source || "unknown"
                                } → ${
                    Array.isArray(p.output_format)
                      ? p.output_format.join(", ")
                      : p.output_format || "unknown"
                  }</span>
                                <span>${
                                  p.created_at
                                    ? new Date(
                                        p.created_at
                                      ).toLocaleDateString()
                                    : ""
                                }</span>
                            </div>
                        </div>
                    `;
                })
                .join("")
            : '<div class="text-center py-8 text-gray-500">No exports found</div>';
        }

        renderDetail() {
          if (!this.selectedExport) return;
          const p = this.selectedExport.properties || {};

          document.getElementById("export-details").innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <h3 class="text-lg font-semibold">${
                              p.name || "Unnamed Export"
                            }</h3>
                            <p class="text-gray-600">${
                              p.description || "No description"
                            }</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><span class="font-medium">Status:</span> ${
                              p.latest_run?.status ||
                              (p.is_processing ? "processing" : "ready")
                            }</div>
                            <div><span class="font-medium">Public:</span> ${
                              p.is_public ? "Yes" : "No"
                            }</div>
                            <div><span class="font-medium">Sources:</span> ${
                              Array.isArray(p.source)
                                ? p.source.join(", ")
                                : p.source || "unknown"
                            }</div>
                            <div><span class="font-medium">Formats:</span> ${
                              Array.isArray(p.output_format)
                                ? p.output_format.join(", ")
                                : p.output_format || "unknown"
                            }</div>
                            <div><span class="font-medium">Created:</span> ${
                              p.created_at
                                ? new Date(p.created_at).toLocaleDateString()
                                : "unknown"
                            }</div>
                            <div><span class="font-medium">User:</span> ${
                              p.user?.includes("@")
                                ? p.user.split("@")[0]
                                : p.user || "unknown"
                            }</div>
                        </div>
                        <div class="flex justify-between items-center">
                            <span></span>
                            <button onclick="app.rerunExport('${
                              p.id || p.id
                            }')" class="px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700">
                                Rerun Export
                            </button>
                        </div>
                    </div>
                `;
        }

        renderRuns(runs) {
          document.getElementById("runs-list").innerHTML = `
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 gap-2">
              <h4 class="text-md font-semibold">Export Runs (${
                runs.length
              })</h4>
            </div>
            ${
              runs.length
                ? `
              <div class="space-y-3 max-h-96 overflow-y-auto">
                ${runs
                  .map(
                    (run) => `
                  <div class="border rounded p-3 bg-white hover:shadow-sm transition-shadow">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-3 gap-2">
                      <div class="flex flex-wrap items-center gap-2">
                        <span class="text-xs px-2 py-1 rounded ${
                          run.status === "completed"
                            ? "bg-green-100 text-green-800"
                            : run.status === "processing"
                            ? "bg-yellow-100 text-yellow-800"
                            : run.status === "queued"
                            ? "bg-blue-100 text-blue-800"
                            : "bg-red-100 text-red-800"
                        }">
                          ${run.status}
                        </span>
                        <span class="text-xs text-gray-500 font-mono">${run.id.substring(
                          0,
                          8
                        )}</span>
                        <span class="text-xs text-gray-500">${
                          run.duration || ""
                        }</span>
                      </div>
                      ${
                        run.status === "completed" && run.download_url
                          ? `<button onclick="app.downloadRun('${
                              run.id
                            }')" class="text-xs px-2 py-1 bg-emerald-600 text-white rounded hover:bg-emerald-700 whitespace-nowrap">
                              Download ${
                                run.file_size
                                  ? `(${(run.file_size / 1024 / 1024).toFixed(
                                      1
                                    )}MB)`
                                  : ""
                              }
                             </button>`
                          : ""
                      }
                      ${
                        run.status === "completed" && run.tiles_url
                          ? `<button onclick="app.downloadTiles('${run.id}')" class="text-xs px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 whitespace-nowrap">
                              Tiles
                             </button>`
                          : ""
                      }
                    </div>
                    
                    ${this.renderSourceComparison({
                      ...run.results,
                      run_id: run.id,
                    })}
                  </div>
                `
                  )
                  .join("")}
              </div>
            `
                : '<div class="text-center py-8 text-gray-500">No runs found</div>'
            }
          `;
        }

        renderSourceComparison(results) {
          if (!results || !results.sources) return "";

          const sources = Object.entries(results.sources);
          const maxBuildings = Math.max(
            ...sources.map(([_, data]) => data.building_count || 0)
          );

          return `
            <div class="space-y-3">
              <div class="flex justify-between items-center">
                <div class="text-xs font-medium text-gray-600">Source Comparison</div>
                <div class="flex space-x-1">
                  <button onclick="app.downloadStats('${
                    results.run_id || ""
                  }')" class="text-xs px-2 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200">Stats JSON</button>
                  ${
                    results.tiles_available || results.tiles_generated
                      ? `<button onclick="app.viewOnMap('${
                          results.run_id || ""
                        }')" class="text-xs px-2 py-1 bg-emerald-100 text-emerald-700 rounded hover:bg-emerald-200">View Tiles</button>`
                      : ""
                  }
                </div>
              </div>
              
              ${
                results.population
                  ? `
                <div class="bg-blue-50 border border-blue-200 rounded p-2 text-xs">
                  <div class="font-medium text-blue-800 flex items-center">
                    Population Data 
                    <span class="ml-1 text-blue-600 cursor-help" title="Population estimate for the selected area">ⓘ</span>
                  </div>
                  <div class="text-blue-700">${
                    results.population.population_estimate?.toLocaleString() ||
                    "N/A"
                  } people</div>
                  <div class="text-blue-600">${
                    results.population.area_km2 || 0
                  }km² • ${results.population.density_per_km2 || 0}/km² • ${
                      results.population.source || "unknown"
                    }</div>
                  ${
                    results.population.year
                      ? `<div class="text-blue-500 text-xs">Data: ${results.population.year}</div>`
                      : ""
                  }
                </div>
              `
                  : ""
              }
              
              ${sources
                .map(([source, data]) => {
                  const buildingCount = data.building_count || 0;
                  const areaKm2 = data.total_area_m2
                    ? (data.total_area_m2 / 1000000).toFixed(1)
                    : 0;
                  const avgArea = data.avg_area_m2
                    ? Math.round(data.avg_area_m2)
                    : buildingCount > 0
                    ? Math.round(data.total_area_m2 / buildingCount)
                    : 0;
                  const percentage =
                    maxBuildings > 0 ? (buildingCount / maxBuildings) * 100 : 0;

                  return `
                    <div class="border border-gray-100 rounded p-2 space-y-2">
                      <div class="flex items-center justify-between">
                        <span class="font-medium capitalize text-sm flex items-center">
                          ${source}
                          <span class="ml-1 text-gray-400 cursor-help text-xs" title="${this.getSourceInfo(
                            source
                          )}">ⓘ</span>
                        </span>
                        <div class="flex space-x-2 text-xs">
                          <span class="text-emerald-700 font-mono">${buildingCount.toLocaleString()}</span>
                          <span class="text-emerald-600">${areaKm2}km²</span>
                          <span class="text-gray-500">${avgArea}m²/bldg</span>
                        </div>
                      </div>
                      <div class="bg-gray-200 rounded-full h-1.5">
                        <div class="h-1.5 rounded-full ${this.getSourceColor(
                          source
                        )}" style="width: ${percentage}%"></div>
                      </div>
                      ${
                        data.attributes && data.attributes.length > 0
                          ? `
                        <div class="text-xs text-gray-500">
                          <span class="font-medium">Attrs:</span> 
                          <span class="cursor-help" title="${data.attributes.join(
                            ", "
                          )}">${data.attributes.slice(0, 4).join(", ")}${
                              data.attributes.length > 4
                                ? ` +${data.attributes.length - 4} more`
                                : ""
                            }</span>
                        </div>
                      `
                          : ""
                      }
                    </div>
                  `;
                })
                .join("")}
              <div class="flex justify-between text-xs pt-1 border-t border-gray-100">
                <span class="font-medium">Total</span>
                <span class="font-mono text-emerald-800">${(
                  results.building_count || 0
                ).toLocaleString()} buildings</span>
              </div>
            </div>
          `;
        }

        getSourceColor(source) {
          const colors = {
            osm: "bg-emerald-500",
            google: "bg-emerald-600",
            microsoft: "bg-emerald-400",
            overture: "bg-emerald-700",
          };
          return colors[source] || "bg-emerald-500";
        }

        getSourceInfo(source) {
          const info = {
            osm: "OpenStreetMap Buildings - Community-contributed building data",
            google:
              "Google Open Buildings - AI-detected buildings from satellite imagery",
            microsoft:
              "Microsoft Building Footprints - AI-generated building outlines",
            overture: "Overture Buildings - Collaborative building dataset",
          };
          return info[source] || "Building footprint data source";
        }

        async rerunExport(exportId) {
          try {
            await this.apiCall(`/exports/rerun/${exportId}/`, {
              method: "POST",
            });
            this.showSuccessToast("Export rerun started!");
            this.loadExportRuns(exportId);
          } catch (error) {
            console.error("Failed to rerun export:", error);
            this.showErrorToast(error.message);
          }
        }

        async downloadRun(runId) {
          try {
            const token = localStorage.getItem("access_token");
            let downloadUrl = `/api/runs/${runId}/download/`;
            let headers = {};

            // Check if this is a public export run
            if (!token) {
              downloadUrl = `/api/public/runs/${runId}/download/`;
            } else {
              headers["Authorization"] = `Bearer ${token}`;
            }

            const response = await fetch(downloadUrl, { headers });

            // If private download fails and we have no token, try public
            if (!response.ok && token) {
              const publicResponse = await fetch(
                `/api/public/runs/${runId}/download/`
              );
              if (publicResponse.ok) {
                const blob = await publicResponse.blob();
                this.triggerDownload(blob, runId);
                return;
              }
            }

            if (!response.ok) {
              throw new Error("Download failed");
            }

            const blob = await response.blob();
            this.triggerDownload(blob, runId);
          } catch (error) {
            console.error("Failed to download:", error);
            this.showErrorToast("Download failed");
          }
        }

        triggerDownload(blob, runId) {
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `export-${runId}.zip`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
          this.showSuccessToast("Download started!");
        }

        async downloadStats(runId) {
          try {
            const data = await this.apiCall(`/runs/${runId}/stats/`);

            const blob = new Blob([JSON.stringify(data, null, 2)], {
              type: "application/json",
            });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `stats-${runId}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            this.showSuccessToast("Stats downloaded!");
          } catch (error) {
            console.error("Failed to download stats:", error);
            this.showErrorToast("Stats download failed");
          }
        }

        async viewOnMap(runId) {
          try {
            const headers = {};
            const token = localStorage.getItem("token");
            if (token) {
              headers["Authorization"] = `Token ${token}`;
            }

            let tilesUrl = `/api/runs/${runId}/tiles/`;
            const response = await fetch(tilesUrl, { headers });

            if (!response.ok) {
              if (response.status === 401 && !token) {
                tilesUrl = `/api/public/runs/${runId}/tiles/`;
                const publicResponse = await fetch(tilesUrl);
                if (!publicResponse.ok) {
                  throw new Error("Tiles not available");
                }
              } else {
                throw new Error("Tiles not available");
              }
            }

            this.loadTilesOnMap(runId, tilesUrl);
            this.showSuccessToast("Tiles loaded on map!");
          } catch (error) {
            console.error("Failed to load tiles:", error);
            this.showErrorToast("Tiles not available");
          }
        }

        loadTilesOnMap(runId, tilesUrl) {
          if (!this.map) return;

          const sourceId = `tiles-${runId}`;
          const layerId = `buildings-${runId}`;

          if (this.map.getSource(sourceId)) {
            this.map.removeLayer(layerId);
            this.map.removeSource(sourceId);
          }

          this.map.addSource(sourceId, {
            type: "vector",
            url: `pmtiles://${window.location.origin}${tilesUrl}`,
          });

          this.map.addLayer({
            id: layerId,
            type: "fill",
            source: sourceId,
            "source-layer": "buildings",
            paint: {
              "fill-color": "#3b82f6",
              "fill-opacity": 0.6,
              "fill-outline-color": "#1d4ed8",
            },
          });

          this.map.on("click", layerId, (e) => {
            if (e.features.length > 0) {
              const feature = e.features[0];
              const popup = new maplibregl.Popup()
                .setLngLat(e.lngLat)
                .setHTML(
                  `
                  <div class="p-2">
                    <h3 class="font-medium">Building</h3>
                    ${Object.entries(feature.properties)
                      .map(
                        ([k, v]) =>
                          `<div class="text-xs"><strong>${k}:</strong> ${v}</div>`
                      )
                      .join("")}
                  </div>
                `
                )
                .addTo(this.map);
            }
          });

          this.map.on("mouseenter", layerId, () => {
            this.map.getCanvas().style.cursor = "pointer";
          });

          this.map.on("mouseleave", layerId, () => {
            this.map.getCanvas().style.cursor = "";
          });
        }

        async downloadTiles(runId) {
          try {
            const headers = {};
            const token = localStorage.getItem("token");
            if (token) {
              headers["Authorization"] = `Token ${token}`;
            }

            let tilesUrl = `/api/runs/${runId}/tiles/`;
            const response = await fetch(tilesUrl, { headers });

            if (!response.ok) {
              if (response.status === 401 && !token) {
                tilesUrl = `/api/public/runs/${runId}/tiles/`;
                const publicResponse = await fetch(tilesUrl);
                if (publicResponse.ok) {
                  const blob = await publicResponse.blob();
                  this.triggerTilesDownload(blob, runId);
                  return;
                }
              }
              throw new Error("Tiles download failed");
            }

            const blob = await response.blob();
            this.triggerTilesDownload(blob, runId);
          } catch (error) {
            console.error("Failed to download tiles:", error);
            this.showErrorToast("Tiles download failed");
          }
        }

        triggerTilesDownload(blob, runId) {
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `tiles-${runId}.pmtiles`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
          this.showSuccessToast("Tiles download started!");
        }

        handleUrlRouting() {
          const path = window.location.pathname;
          const match = path.match(/^\/public\/([^\/]+)\/?$/);

          if (match) {
            const exportId = match[1];
            this.loadPublicExport(exportId);
          }
        }

        async loadPublicExport(exportId) {
          try {
            const export_data = await fetch(`/api/public/exports/${exportId}/`);
            const export_json = await export_data.json();

            if (export_json) {
              this.exports = [export_json];
              this.selectedExport = export_json;
              this.currentView = "detail";
              this.render();
              this.loadPublicExportRuns(exportId);
            }
          } catch (error) {
            console.error("Failed to load public export:", error);
            this.showErrorToast("Export not found or not public");
          }
        }

        async loadPublicExportRuns(exportId) {
          try {
            const data = await fetch(`/api/public/exports/${exportId}/runs/`);
            const runs = await data.json();
            this.renderRuns(runs.results || []);
          } catch (error) {
            console.error("Failed to load public runs:", error);
          }
        }

        showErrorToast(message) {
          const toast = document.createElement("div");
          toast.className =
            "fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded shadow-lg z-50";
          toast.textContent = message;
          document.body.appendChild(toast);
          setTimeout(() => {
            document.body.removeChild(toast);
          }, 3000);
        }

        showInfoToast(message) {
          const toast = document.createElement("div");
          toast.className =
            "fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded shadow-lg z-50";
          toast.textContent = message;
          document.body.appendChild(toast);
          setTimeout(() => {
            document.body.removeChild(toast);
          }, 3000);
        }

        updateMap() {
          ["exports-fill", "exports-stroke"].forEach((id) => {
            if (this.map.getLayer(id)) this.map.removeLayer(id);
          });
          if (this.map.getSource("exports")) this.map.removeSource("exports");

          let filtered = [];
          if (this.currentView === "detail" && this.selectedExport) {
            filtered = [this.selectedExport];
          } else {
            filtered = this.exports;
          }

          if (filtered.length > 0) {
            console.log("Adding", filtered.length, "exports to map:", filtered);

            this.map.addSource("exports", {
              type: "geojson",
              data: { type: "FeatureCollection", features: filtered },
            });

            this.map.addLayer({
              id: "exports-fill",
              type: "fill",
              source: "exports",
              paint: { "fill-color": "#10b981", "fill-opacity": 0.2 },
            });

            this.map.addLayer({
              id: "exports-stroke",
              type: "line",
              source: "exports",
              paint: { "line-color": "#059669", "line-width": 2 },
            });

            const allCoords = filtered.flatMap(
              (f) => f.geometry?.coordinates?.[0] || []
            );
            if (allCoords.length > 0) {
              const bounds = allCoords.reduce(
                (b, coord) => b.extend(coord),
                new maplibregl.LngLatBounds(allCoords[0], allCoords[0])
              );
              this.map.fitBounds(bounds, { padding: 50 });
            }
          }
        }
      }

      const app = new OBEApp();
    </script>
  </body>
</html>
