<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OBE - Open Building Exports</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css"
    />
    <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
    <script src="https://unpkg.com/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.js"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.css"
    />
    <style>
      .maplibregl-ctrl-top-right {
        z-index: 2;
      }
      .maplibregl-draw-polygon.maplibregl-draw-active {
        cursor: crosshair;
      }
      .search-dropdown {
        max-height: 200px;
        overflow-y: auto;
      }
      #map {
        height: 70vh;
        min-height: 400px;
      }
      @media (max-width: 768px) {
        #map {
          height: 50vh;
          min-height: 300px;
        }
        .grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <div class="bg-white shadow-sm border-b">
      <div
        class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center"
      >
        <h1
          class="text-2xl font-bold text-emerald-600 cursor-pointer"
          onclick="app.showExports()"
        >
          OBE
        </h1>
        <div id="auth-buttons" class="flex space-x-3">
          <button
            id="login-btn"
            class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded"
          >
            Login
          </button>
          <button
            id="signup-btn"
            class="px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700"
          >
            Sign Up
          </button>
          <button
            id="logout-btn"
            class="hidden px-4 py-2 text-gray-600 hover:bg-gray-100 rounded"
          >
            Logout
          </button>
        </div>
      </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 py-6">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-1">
          <div class="bg-white rounded-lg shadow-sm">
            <div id="exports-view" class="p-6">
              <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold">Exports</h2>
                <div class="flex space-x-2">
                  <button
                    id="show-all"
                    class="px-3 py-1 text-sm bg-emerald-100 text-emerald-700 rounded"
                  >
                    All
                  </button>
                  <button
                    id="show-mine"
                    class="hidden px-3 py-1 text-sm text-gray-600 hover:bg-gray-100 rounded"
                  >
                    Mine
                  </button>
                  <button
                    id="create-new"
                    class="px-3 py-1 text-sm bg-emerald-600 text-white rounded hover:bg-emerald-700"
                  >
                    + New
                  </button>
                </div>
              </div>
              <div
                id="exports-list"
                class="space-y-3 max-h-96 overflow-y-auto"
              ></div>
            </div>

            <div id="auth-view" class="hidden p-6">
              <h2 id="auth-title" class="text-xl font-semibold mb-6">Login</h2>
              <form id="auth-form" class="space-y-4">
                <input
                  id="username"
                  type="text"
                  placeholder="Username"
                  required
                  class="w-full px-3 py-2 border rounded focus:border-emerald-500"
                />
                <input
                  id="email"
                  type="email"
                  placeholder="Email"
                  class="hidden w-full px-3 py-2 border rounded focus:border-emerald-500"
                />
                <input
                  id="password"
                  type="password"
                  placeholder="Password"
                  required
                  class="w-full px-3 py-2 border rounded focus:border-emerald-500"
                />
                <div id="auth-error" class="hidden text-red-600 text-sm"></div>
                <div class="flex space-x-3">
                  <button
                    type="submit"
                    class="flex-1 bg-emerald-600 text-white py-2 rounded hover:bg-emerald-700"
                  >
                    <span id="auth-btn-text">Login</span>
                  </button>
                  <button
                    type="button"
                    id="auth-cancel"
                    class="flex-1 bg-gray-300 text-gray-700 py-2 rounded hover:bg-gray-400"
                  >
                    Cancel
                  </button>
                </div>
                <button
                  type="button"
                  id="auth-toggle"
                  class="w-full text-sm text-emerald-600 hover:text-emerald-700"
                >
                  Don't have an account? Sign up
                </button>
              </form>
            </div>

            <div id="create-view" class="hidden p-6">
              <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold">Create Export</h2>
                <button
                  id="create-cancel"
                  class="text-gray-500 hover:text-gray-700"
                >
                  ✕
                </button>
              </div>
              <div
                id="draw-status"
                class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-800"
              >
                Draw area on map or upload file
              </div>
              <form id="create-form" class="space-y-4">
                <input
                  id="export-name"
                  type="text"
                  placeholder="Export name"
                  required
                  class="w-full px-3 py-2 border rounded focus:border-emerald-500"
                />
                <textarea
                  id="export-desc"
                  placeholder="Description (optional)"
                  class="w-full px-3 py-2 border rounded focus:border-emerald-500 h-16"
                ></textarea>
                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="block text-sm font-medium mb-1">Source</label>
                    <select
                      id="export-source"
                      multiple
                      class="w-full px-3 py-2 border rounded focus:border-emerald-500 h-20 text-sm"
                    >
                      <option value="google">Google</option>
                      <option value="microsoft">Microsoft</option>
                      <option value="osm">OpenStreetMap</option>
                      <option value="overture">Overture</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-1">Format</label>
                    <select
                      id="export-format"
                      multiple
                      class="w-full px-3 py-2 border rounded focus:border-emerald-500 h-20 text-sm"
                    >
                      <option value="geoparquet">GeoParquet</option>
                      <option value="geojson">GeoJSON</option>
                      <option value="shapefile">Shapefile</option>
                      <option value="geopackage">GeoPackage</option>
                    </select>
                  </div>
                </div>
                <div id="source-configs" class="space-y-3"></div>
                <div class="flex items-center space-x-2">
                  <input id="export-public" type="checkbox" class="rounded" />
                  <label class="text-sm">Make public</label>
                </div>
                <div
                  class="border-2 border-dashed border-gray-300 rounded p-4 text-center"
                >
                  <input
                    type="file"
                    id="file-upload"
                    accept=".geojson,.json,.kml,.gpx"
                    class="hidden"
                  />
                  <button
                    type="button"
                    id="upload-btn"
                    class="text-emerald-600 hover:text-emerald-700"
                  >
                    Upload boundary file
                  </button>
                  <p class="text-xs text-gray-500 mt-1">GeoJSON, KML, GPX</p>
                </div>
                <div
                  id="create-error"
                  class="hidden text-red-600 text-sm"
                ></div>
                <button
                  type="submit"
                  id="create-submit"
                  disabled
                  class="w-full bg-gray-400 text-white py-2 rounded cursor-not-allowed"
                >
                  Create Export
                </button>
              </form>
            </div>

            <div id="detail-view" class="hidden p-6">
              <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold">Export Details</h2>
                <button
                  id="detail-cancel"
                  class="text-gray-500 hover:text-gray-700"
                >
                  ✕
                </button>
              </div>
              <div id="export-details"></div>
              <div id="runs-list" class="mt-6"></div>
            </div>
          </div>
        </div>

        <div class="lg:col-span-2">
          <div class="bg-white rounded-lg shadow-sm p-4">
            <div id="map" class="w-full rounded border"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      class OBEApp {
        constructor() {
          this.exports = [];
          this.user = null;
          this.showMine = false;
          this.currentView = "exports";
          this.drawnArea = null;
          this.isLogin = true;
          this.countries = [];
          this.selectedExport = null;
          this.init();
        }

        async init() {
          await this.loadCountries();
          this.map = new maplibregl.Map({
            container: "map",
            style:
              "https://basemaps.cartocdn.com/gl/positron-gl-style/style.json",
            center: [0, 20],
            zoom: 2,
          });

          this.map.on("load", () => {
            this.draw = new MapboxDraw({
              displayControlsDefault: false,
              controls: { polygon: true, trash: true },
              defaultMode: "simple_select",
            });
            this.map.addControl(this.draw, "top-right");
            this.map.on("draw.create", (e) =>
              this.updateDrawnArea(e.features[0])
            );
            this.map.on("draw.update", (e) =>
              this.updateDrawnArea(e.features[0])
            );
            this.map.on("draw.delete", () => this.updateDrawnArea(null));
          });

          this.setupEvents();
          this.checkAuth();
          this.loadExports();
        }

        async loadCountries() {
          try {
            const response = await fetch(
              "https://raw.githubusercontent.com/kshitijrajsharma/global-boundaries-bbox/refs/heads/main/countries.json"
            );
            this.countries = await response.json();
          } catch (error) {
            console.error("Failed to load countries:", error);
            this.countries = [];
          }
        }

        async apiCall(endpoint, options = {}) {
          const token = localStorage.getItem("access_token");
          const headers = { "Content-Type": "application/json" };
          if (token) headers.Authorization = `Bearer ${token}`;

          const response = await fetch(`/api${endpoint}`, {
            ...options,
            headers: { ...headers, ...options.headers },
          });

          if (!response.ok) {
            const data = await response.json();
            throw new Error(data.detail || "Request failed");
          }
          return await response.json();
        }

        checkAuth() {
          const token = localStorage.getItem("access_token");
          const username = localStorage.getItem("username");
          if (token && username) this.user = username;
          this.render();
        }

        async loadExports() {
          try {
            let data;
            if (this.showMine && this.user) {
              data = await this.apiCall("/exports/?ordering=-created_at");
            } else {
              data = await this.apiCall(
                "/public/exports/?ordering=-created_at"
              );
            }
            this.exports = data.results?.features || data.features || [];
            console.log("Loaded exports:", this.exports);
          } catch (error) {
            console.error("Failed to load exports:", error);
            this.exports = [];
          }
          this.render();
        }

        setupEvents() {
          document.getElementById("login-btn").onclick = () =>
            this.showAuth(true);
          document.getElementById("signup-btn").onclick = () =>
            this.showAuth(false);
          document.getElementById("logout-btn").onclick = () => this.logout();
          document.getElementById("show-all").onclick = () =>
            this.toggleFilter(false);
          document.getElementById("show-mine").onclick = () =>
            this.toggleFilter(true);
          document.getElementById("create-new").onclick = () =>
            this.showCreate();
          document.getElementById("auth-cancel").onclick = () =>
            this.showExports();
          document.getElementById("auth-toggle").onclick = () =>
            this.toggleAuthMode();
          document.getElementById("create-cancel").onclick = () =>
            this.showExports();
          document.getElementById("detail-cancel").onclick = () =>
            this.showExports();
          document.getElementById("export-source").onchange = () =>
            this.updateSourceConfigs();
          document.getElementById("upload-btn").onclick = () =>
            document.getElementById("file-upload").click();
          document.getElementById("file-upload").onchange = (e) =>
            this.handleFileUpload(e);
          document.getElementById("auth-form").onsubmit = (e) =>
            this.handleAuth(e);
          document.getElementById("create-form").onsubmit = (e) =>
            this.handleCreate(e);
        }

        showAuth(isLogin) {
          this.isLogin = isLogin;
          this.currentView = "auth";
          this.render();
        }

        showExports() {
          this.currentView = "exports";
          this.selectedExport = null;
          this.render();
        }

        showCreate() {
          if (!this.user) {
            this.showAuth(true);
            return;
          }
          this.currentView = "create";
          if (this.draw) this.draw.changeMode("draw_polygon");
          this.render();
        }

        showDetail(exportId) {
          this.selectedExport = this.exports.find(
            (e) => (e.properties?.id || e.id) === exportId
          );
          this.currentView = "detail";
          this.render();
          this.loadExportRuns(exportId);
        }

        async loadExportRuns(exportId) {
          try {
            const data = await this.apiCall(`/exports/${exportId}/runs/`);
            this.renderRuns(data.results || []);
          } catch (error) {
            console.error("Failed to load runs:", error);
          }
        }

        toggleFilter(mine) {
          this.showMine = mine;
          this.loadExports();
        }

        toggleAuthMode() {
          this.isLogin = !this.isLogin;
          this.render();
        }

        updateSourceConfigs() {
          const sourceSelect = document.getElementById("export-source");
          const configContainer = document.getElementById("source-configs");
          const selectedSources = Array.from(sourceSelect.selectedOptions).map(
            (option) => option.value
          );

          configContainer.innerHTML = "";

          selectedSources.forEach((source) => {
            if (source === "microsoft") {
              configContainer.innerHTML += `
                            <div class="microsoft-config">
                                <label class="block text-sm font-medium mb-1">Microsoft Location</label>
                                <div class="relative">
                                    <input id="microsoft-search" type="text" placeholder="Search country..." class="w-full px-3 py-2 border rounded focus:border-emerald-500">
                                    <div id="microsoft-dropdown" class="hidden absolute z-10 w-full bg-white border rounded-b shadow-lg search-dropdown">
                                        ${this.countries
                                          .map(
                                            (country) =>
                                              `<div class="px-3 py-2 hover:bg-gray-100 cursor-pointer country-option" data-value="${country.shapeName}">${country.shapeName}</div>`
                                          )
                                          .join("")}
                                    </div>
                                </div>
                            </div>
                        `;

              setTimeout(() => {
                const searchInput = document.getElementById("microsoft-search");
                const dropdown = document.getElementById("microsoft-dropdown");
                searchInput.onfocus = () => dropdown.classList.remove("hidden");
                searchInput.onblur = () =>
                  setTimeout(() => dropdown.classList.add("hidden"), 200);
                searchInput.oninput = (e) =>
                  this.filterCountries(e.target.value);
                dropdown.onclick = (e) => {
                  if (e.target.classList.contains("country-option")) {
                    searchInput.value = e.target.dataset.value;
                    dropdown.classList.add("hidden");
                  }
                };
              }, 100);
            }
          });
        }

        filterCountries(query) {
          const options = document.querySelectorAll(".country-option");
          options.forEach((option) => {
            const matches = option.textContent
              .toLowerCase()
              .includes(query.toLowerCase());
            option.style.display = matches ? "block" : "none";
          });
        }

        updateDrawnArea(area) {
          this.drawnArea = area;
          if (this.currentView === "create") this.updateCreateButton();
        }

        updateCreateButton() {
          const btn = document.getElementById("create-submit");
          const status = document.getElementById("draw-status");

          if (this.drawnArea) {
            btn.disabled = false;
            btn.className =
              "w-full bg-emerald-600 text-white py-2 rounded hover:bg-emerald-700";
            status.innerHTML = "Area selected";
            status.className =
              "mb-4 p-3 bg-green-50 border border-green-200 rounded text-sm text-green-800";
          } else {
            btn.disabled = true;
            btn.className =
              "w-full bg-gray-400 text-white py-2 rounded cursor-not-allowed";
            status.innerHTML = "Draw area on map or upload file";
            status.className =
              "mb-4 p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-800";
          }
        }

        async handleAuth(e) {
          e.preventDefault();
          const username = document.getElementById("username").value;
          const password = document.getElementById("password").value;
          const email = document.getElementById("email").value;

          try {
            const endpoint = this.isLogin ? "/auth/login/" : "/auth/register/";
            const body = this.isLogin
              ? { username, password }
              : { username, password, email };

            const data = await this.apiCall(endpoint, {
              method: "POST",
              body: JSON.stringify(body),
            });

            localStorage.setItem(
              "access_token",
              data.access_token || data.access
            );
            localStorage.setItem("username", username);
            this.user = username;
            this.showExports();
          } catch (error) {
            document.getElementById("auth-error").textContent = error.message;
            document.getElementById("auth-error").classList.remove("hidden");
          }
        }

        async handleCreate(e) {
          e.preventDefault();

          if (!this.drawnArea) {
            document.getElementById("create-error").textContent =
              "Please draw an area or upload a file";
            document.getElementById("create-error").classList.remove("hidden");
            return;
          }

          const formData = {
            name: document.getElementById("export-name").value,
            description: document.getElementById("export-desc").value,
            source: Array.from(
              document.getElementById("export-source").selectedOptions
            ).map((o) => o.value),
            output_format: Array.from(
              document.getElementById("export-format").selectedOptions
            ).map((o) => o.value),
            is_public: document.getElementById("export-public").checked,
            area_of_interest: this.drawnArea.geometry,
            source_config: {},
          };

          const microsoftSearch = document.getElementById("microsoft-search");
          if (microsoftSearch && microsoftSearch.value) {
            formData.source_config.location = microsoftSearch.value;
          }

          try {
            const result = await this.apiCall("/exports/", {
              method: "POST",
              body: JSON.stringify(formData),
            });

            this.showSuccessToast("Export created successfully!");

            this.draw.delete(this.drawnArea.id);
            this.drawnArea = null;
            this.showExports();
            this.loadExports();
          } catch (error) {
            document.getElementById("create-error").textContent = error.message;
            document.getElementById("create-error").classList.remove("hidden");
          }
        }

        handleFileUpload(e) {
          const file = e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const data = JSON.parse(event.target.result);
              let geometry = data.geometry || data;

              if (
                data.type === "FeatureCollection" &&
                data.features.length > 0
              ) {
                geometry = data.features[0].geometry;
              }

              if (geometry.type === "Polygon") {
                const feature = { type: "Feature", geometry };
                this.draw.add(feature);
                this.updateDrawnArea(feature);
              }
            } catch (error) {
              alert("Invalid file format");
            }
          };
          reader.readAsText(file);
        }

        showSuccessToast(message) {
          const toast = document.createElement("div");
          toast.className =
            "fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg z-50";
          toast.textContent = message;
          document.body.appendChild(toast);
          setTimeout(() => {
            document.body.removeChild(toast);
          }, 3000);
        }

        logout() {
          localStorage.removeItem("access_token");
          localStorage.removeItem("username");
          this.user = null;
          this.showMine = false;
          this.showExports();
        }

        render() {
          document
            .getElementById("exports-view")
            .classList.toggle("hidden", this.currentView !== "exports");
          document
            .getElementById("auth-view")
            .classList.toggle("hidden", this.currentView !== "auth");
          document
            .getElementById("create-view")
            .classList.toggle("hidden", this.currentView !== "create");
          document
            .getElementById("detail-view")
            .classList.toggle("hidden", this.currentView !== "detail");

          if (this.currentView === "auth") this.renderAuth();
          if (this.currentView === "exports") this.renderExports();
          if (this.currentView === "create") this.updateCreateButton();
          if (this.currentView === "detail") this.renderDetail();

          document
            .getElementById("logout-btn")
            .classList.toggle("hidden", !this.user);
          document
            .getElementById("login-btn")
            .classList.toggle("hidden", !!this.user);
          document
            .getElementById("signup-btn")
            .classList.toggle("hidden", !!this.user);
          document
            .getElementById("show-mine")
            .classList.toggle("hidden", !this.user);

          this.updateMap();
        }

        renderAuth() {
          document.getElementById("auth-title").textContent = this.isLogin
            ? "Login"
            : "Sign Up";
          document.getElementById("auth-btn-text").textContent = this.isLogin
            ? "Login"
            : "Sign Up";
          document
            .getElementById("email")
            .classList.toggle("hidden", this.isLogin);
          document.getElementById("auth-toggle").textContent = this.isLogin
            ? "Don't have an account? Sign up"
            : "Already have an account? Login";
        }

        renderExports() {
          console.log("Rendering exports:", this.exports);

          const filtered = this.exports;

          document.getElementById("show-all").className = this.showMine
            ? "px-3 py-1 text-sm text-gray-600 hover:bg-gray-100 rounded"
            : "px-3 py-1 text-sm bg-emerald-100 text-emerald-700 rounded";
          document.getElementById("show-mine").className = this.showMine
            ? "px-3 py-1 text-sm bg-emerald-100 text-emerald-700 rounded"
            : "px-3 py-1 text-sm text-gray-600 hover:bg-gray-100 rounded";

          document.getElementById("exports-list").innerHTML = filtered.length
            ? filtered
                .map((exp) => {
                  const p = exp.properties || {};
                  const id = p.id || exp.id;
                  const statusColor =
                    p.status === "completed"
                      ? "green"
                      : p.status === "processing"
                      ? "yellow"
                      : "red";
                  return `
                        <div class="border rounded p-3 cursor-pointer hover:bg-gray-50" onclick="app.showDetail('${id}')">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-semibold truncate">${
                                  p.name || "Unnamed Export"
                                }</h4>
                                <div class="flex space-x-1">
                                    <span class="text-xs px-2 py-1 rounded ${
                                      p.is_public
                                        ? "bg-emerald-100 text-emerald-800"
                                        : "bg-gray-100 text-gray-600"
                                    }">
                                        ${p.is_public ? "Public" : "Private"}
                                    </span>
                                    <span class="text-xs px-2 py-1 rounded bg-${statusColor}-100 text-${statusColor}-800">${
                    p.is_processing || "unknown"
                  }</span>
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 mb-2">${
                              p.description || "No description"
                            }</p>
                            <div class="flex justify-between text-xs text-gray-500">
                                <span>${
                                  Array.isArray(p.source)
                                    ? p.source.join(", ")
                                    : p.source || "unknown"
                                } → ${
                    Array.isArray(p.output_format)
                      ? p.output_format.join(", ")
                      : p.output_format || "unknown"
                  }</span>
                                <span>${
                                  p.created_at
                                    ? new Date(
                                        p.created_at
                                      ).toLocaleDateString()
                                    : ""
                                }</span>
                            </div>
                        </div>
                    `;
                })
                .join("")
            : '<div class="text-center py-8 text-gray-500">No exports found</div>';
        }

        renderDetail() {
          if (!this.selectedExport) return;
          const p = this.selectedExport.properties || {};

          document.getElementById("export-details").innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <h3 class="text-lg font-semibold">${
                              p.name || "Unnamed Export"
                            }</h3>
                            <p class="text-gray-600">${
                              p.description || "No description"
                            }</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><span class="font-medium">Status:</span> ${
                              p.status || "unknown"
                            }</div>
                            <div><span class="font-medium">Public:</span> ${
                              p.is_public ? "Yes" : "No"
                            }</div>
                            <div><span class="font-medium">Sources:</span> ${
                              Array.isArray(p.source)
                                ? p.source.join(", ")
                                : p.source || "unknown"
                            }</div>
                            <div><span class="font-medium">Formats:</span> ${
                              Array.isArray(p.output_format)
                                ? p.output_format.join(", ")
                                : p.output_format || "unknown"
                            }</div>
                            <div><span class="font-medium">Created:</span> ${
                              p.created_at
                                ? new Date(p.created_at).toLocaleDateString()
                                : "unknown"
                            }</div>
                            <div><span class="font-medium">User:</span> ${
                              p.user || "unknown"
                            }</div>
                        </div>
                        <div class="flex justify-between items-center">
                            <span></span>
                            <button onclick="app.rerunExport('${
                              p.id || p.id
                            }')" class="px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700">
                                Rerun Export
                            </button>
                        </div>
                    </div>
                `;
        }

        renderRuns(runs) {
          document.getElementById("runs-list").innerHTML = `
            <div class="flex justify-between items-center mb-3">
              <h4 class="text-md font-semibold">Export Runs</h4>
            </div>
            ${
              runs.length
                ? `
              <div class="overflow-x-auto">
                <table class="w-full text-sm border-collapse border border-gray-200">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="border border-gray-200 px-3 py-2 text-left">Run ID</th>
                      <th class="border border-gray-200 px-3 py-2 text-left">Status</th>
                      <th class="border border-gray-200 px-3 py-2 text-left">Created</th>
                      <th class="border border-gray-200 px-3 py-2 text-left">Results</th>
                      <th class="border border-gray-200 px-3 py-2 text-left">Download</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${runs
                      .map(
                        (run) => `
                      <tr class="hover:bg-gray-50">
                        <td class="border border-gray-200 px-3 py-2 font-mono text-xs">${run.id.substring(
                          0,
                          8
                        )}...</td>
                        <td class="border border-gray-200 px-3 py-2">
                          <span class="text-xs px-2 py-1 rounded ${
                            run.status === "completed"
                              ? "bg-green-100 text-green-800"
                              : run.status === "processing"
                              ? "bg-yellow-100 text-yellow-800"
                              : run.status === "queued"
                              ? "bg-blue-100 text-blue-800"
                              : "bg-red-100 text-red-800"
                          }">
                            ${run.status}
                          </span>
                        </td>
                        <td class="border border-gray-200 px-3 py-2">
                          ${
                            run.created_at
                              ? new Date(run.created_at).toLocaleString()
                              : "N/A"
                          }
                        </td>
                        <td class="border border-gray-200 px-3 py-2">
                          ${this.formatRunResults(run.results || {})}
                        </td>
                        <td class="border border-gray-200 px-3 py-2">
                          ${
                            run.status === "completed" && run.output_file
                              ? `<a href="/api/runs/${run.id}/download/" class="text-xs px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">Download ZIP</a>`
                              : '<span class="text-gray-400 text-xs">Not available</span>'
                          }
                        </td>
                      </tr>
                    `
                      )
                      .join("")}
                  </tbody>
                </table>
              </div>
            `
                : '<div class="text-center py-8 text-gray-500">No runs found</div>'
            }
          `;
        }

        formatRunResults(results) {
          if (!results || Object.keys(results).length === 0) {
            return '<span class="text-gray-400 text-xs">No results</span>';
          }

          return Object.entries(results)
            .map(([source, data]) => {
              const count = data.building_count || 0;
              return `<div class="text-xs"><span class="font-medium">${source}:</span> ${count} buildings</div>`;
            })
            .join("");
        }

        async rerunExport(exportId) {
          try {
            await this.apiCall(`/exports/rerun/${exportId}/`, {
              method: "POST",
            });
            this.showSuccessToast("Export rerun started!");
            this.loadExportRuns(exportId);
          } catch (error) {
            console.error("Failed to rerun export:", error);
            this.showErrorToast(error.message);
          }
        }

        showErrorToast(message) {
          const toast = document.createElement("div");
          toast.className =
            "fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded shadow-lg z-50";
          toast.textContent = message;
          document.body.appendChild(toast);
          setTimeout(() => {
            document.body.removeChild(toast);
          }, 3000);
        }

        updateMap() {
          ["exports-fill", "exports-stroke"].forEach((id) => {
            if (this.map.getLayer(id)) this.map.removeLayer(id);
          });
          if (this.map.getSource("exports")) this.map.removeSource("exports");

          let filtered = [];
          if (this.currentView === "detail" && this.selectedExport) {
            filtered = [this.selectedExport];
          } else {
            filtered = this.exports;
          }

          if (filtered.length > 0) {
            console.log("Adding", filtered.length, "exports to map:", filtered);

            this.map.addSource("exports", {
              type: "geojson",
              data: { type: "FeatureCollection", features: filtered },
            });

            this.map.addLayer({
              id: "exports-fill",
              type: "fill",
              source: "exports",
              paint: { "fill-color": "#10b981", "fill-opacity": 0.2 },
            });

            this.map.addLayer({
              id: "exports-stroke",
              type: "line",
              source: "exports",
              paint: { "line-color": "#059669", "line-width": 2 },
            });

            const allCoords = filtered.flatMap(
              (f) => f.geometry?.coordinates?.[0] || []
            );
            if (allCoords.length > 0) {
              const bounds = allCoords.reduce(
                (b, coord) => b.extend(coord),
                new maplibregl.LngLatBounds(allCoords[0], allCoords[0])
              );
              this.map.fitBounds(bounds, { padding: 50 });
            }
          }
        }
      }

      const app = new OBEApp();
    </script>
  </body>
</html>
